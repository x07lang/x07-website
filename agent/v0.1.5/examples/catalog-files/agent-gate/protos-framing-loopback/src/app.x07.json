{"decls":[{"kind":"export","names":["app.client_v1","app.server_v1"]},{"body":["begin",["let","out",["std.vec.with_capacity",16384]],["for","i",0,256,["begin",["let","doc",["begin",["let","h",["std.net.tcp.stream_read_task_v1","stream_handle",4096,"caps",5000]],["task.spawn","h"],["await","h"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","doc"]],1],["return",["bytes.lit","ERROR:read"]],0],["let","payload",["std.net.tcp.stream_read_payload_v1",["bytes.view","doc"]]],["if",["=",["bytes.len",["bytes.view","payload"]],0],["return",["std.vec.as_bytes","out"]],0],["set","out",["std.vec.extend_bytes","out",["bytes.view","payload"]]],0]],["std.vec.as_bytes","out"]],"kind":"defasync","name":"app._read_all_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","h",["std.net.io.write_all_task_v1","stream_handle","data","caps",5000]],["task.spawn","h"],["await","h"]],"kind":"defasync","name":"app._write_all_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"data","ty":"bytes_view"},{"name":"caps","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","conn_doc",["begin",["let","h",["std.net.tcp.connect_task_v1",["bytes.view","addr"],["bytes.view","caps"],5000]],["task.spawn","h"],["await","h"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","conn_doc"]],1],["return",["bytes.lit","ERROR:connect"]],0],["let","stream",["std.net.tcp.connect_stream_handle_v1",["bytes.view","conn_doc"]]],["let","ws_payload0",["bytes.lit","hello"]],["let","ws_res",["std.net.ws.frame_v1",1,1,["bytes.view","ws_payload0"]]],["if",["!=",["result_bytes.err_code","ws_res"],0],["return",["bytes.lit","ERROR:ws_build"]],0],["let","ws_frame",["result_bytes.unwrap_or","ws_res",["bytes.alloc",0]]],["let","grpc_payload0",["bytes.lit","ping"]],["let","grpc_res",["std.net.grpc.msg_prefix_v1",0,["bytes.view","grpc_payload0"]]],["if",["!=",["result_bytes.err_code","grpc_res"],0],["return",["bytes.lit","ERROR:grpc_build"]],0],["let","grpc_frame",["result_bytes.unwrap_or","grpc_res",["bytes.alloc",0]]],["let","req",["std.vec.with_capacity",512]],["begin",["let","ws_len_le",["std.codec.write_u32_le",["bytes.len",["bytes.view","ws_frame"]]]],["set","req",["std.vec.extend_bytes","req",["bytes.view","ws_len_le"]]]],["set","req",["std.vec.extend_bytes","req",["bytes.view","ws_frame"]]],["begin",["let","grpc_len_le",["std.codec.write_u32_le",["bytes.len",["bytes.view","grpc_frame"]]]],["set","req",["std.vec.extend_bytes","req",["bytes.view","grpc_len_le"]]]],["set","req",["std.vec.extend_bytes","req",["bytes.view","grpc_frame"]]],["let","req_b",["std.vec.as_bytes","req"]],["let","wdoc",["begin",["let","h",["app._write_all_v1","stream",["bytes.view","req_b"],["bytes.view","caps"]]],["task.spawn","h"],["await","h"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","wdoc"]],1],["return",["bytes.lit","ERROR:write"]],0],["std.net.tcp.stream_shutdown_v1","stream",["std.net.tcp.shutdown_write_v1"]],["let","err_read",["bytes.lit","ERROR:read"]],["let","resp",["begin",["let","h",["app._read_all_v1","stream",["bytes.view","caps"]]],["task.spawn","h"],["await","h"]]],["std.net.tcp.stream_close_v1","stream"],["if",["=",["std.bytes.eq",["bytes.view","resp"],["bytes.view","err_read"]],1],["return","resp"],0],["let","resp_len",["bytes.len",["bytes.view","resp"]]],["if",["<","resp_len",8],["return",["bytes.lit","ERROR:resp_short"]],0],["let","m1",["std.codec.read_u32_le",["bytes.view","resp"],0]],["if",["<","m1",0],["return",["bytes.lit","ERROR:resp_len_neg"]],0],["let","off2",["+","m1",4]],["if",[">",["+","off2",4],"resp_len"],["return",["bytes.lit","ERROR:resp_bounds"]],0],["let","m2",["std.codec.read_u32_le",["bytes.view","resp"],"off2"]],["if",["<","m2",0],["return",["bytes.lit","ERROR:resp_len_neg"]],0],["let","off3",["+","off2",4]],["if",[">",["+","off3","m2"],"resp_len"],["return",["bytes.lit","ERROR:resp_bounds"]],0],["let","ws_payload1",["std.bytes.slice",["bytes.view","resp"],4,"m1"]],["let","grpc_payload1",["std.bytes.slice",["bytes.view","resp"],"off3","m2"]],["let","json",["std.vec.with_capacity",256]],["begin",["let","prefix",["bytes.lit","{\"grpc\":\""]],["set","json",["std.vec.extend_bytes","json",["bytes.view","prefix"]]]],["set","json",["std.vec.extend_bytes","json",["bytes.view","grpc_payload1"]]],["begin",["let","mid",["bytes.lit","\",\"ok\":true,\"ws\":\""]],["set","json",["std.vec.extend_bytes","json",["bytes.view","mid"]]]],["set","json",["std.vec.extend_bytes","json",["bytes.view","ws_payload1"]]],["begin",["let","suffix",["bytes.lit","\"}"]],["set","json",["std.vec.extend_bytes","json",["bytes.view","suffix"]]]],["let","raw",["std.vec.as_bytes","json"]],["let","canon",["std.json.canonicalize_small",["bytes.view","raw"]]],["begin",["let","nl",["bytes.lit","\n"]],["std.bytes.concat",["bytes.view","canon"],["bytes.view","nl"]]]],"kind":"defasync","name":"app.client_v1","params":[{"name":"addr","ty":"bytes"},{"name":"caps","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","listen_doc",["std.net.tcp.listen_v1",["bytes.view","addr"],["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","listen_doc"]],1],["return",["bytes.lit","ERROR:listen"]],0],["let","listener",["std.net.tcp.listen_listener_handle_v1",["bytes.view","listen_doc"]]],["let","acc_doc",["begin",["let","h",["std.net.tcp.accept_task_v1","listener",["bytes.view","caps"],5000]],["task.spawn","h"],["await","h"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","acc_doc"]],1],["return",["bytes.lit","ERROR:accept"]],0],["let","stream",["std.net.tcp.accept_stream_handle_v1",["bytes.view","acc_doc"]]],["let","err_read",["bytes.lit","ERROR:read"]],["let","req",["begin",["let","h",["app._read_all_v1","stream",["bytes.view","caps"]]],["task.spawn","h"],["await","h"]]],["if",["=",["std.bytes.eq",["bytes.view","req"],["bytes.view","err_read"]],1],["return","req"],0],["let","req_len",["bytes.len",["bytes.view","req"]]],["if",["<","req_len",8],["return",["bytes.lit","ERROR:req_short"]],0],["let","n1",["std.codec.read_u32_le",["bytes.view","req"],0]],["if",["<","n1",0],["return",["bytes.lit","ERROR:req_len_neg"]],0],["let","off2",["+","n1",4]],["if",[">",["+","off2",4],"req_len"],["return",["bytes.lit","ERROR:req_bounds"]],0],["let","n2",["std.codec.read_u32_le",["bytes.view","req"],"off2"]],["if",["<","n2",0],["return",["bytes.lit","ERROR:req_len_neg"]],0],["let","off3",["+","off2",4]],["if",[">",["+","off3","n2"],"req_len"],["return",["bytes.lit","ERROR:req_bounds"]],0],["let","ws_frame",["std.bytes.slice",["bytes.view","req"],4,"n1"]],["let","grpc_frame",["std.bytes.slice",["bytes.view","req"],"off3","n2"]],["if",["=",["std.net.ws.frame_is_valid_v1",["bytes.view","ws_frame"]],0],["return",["bytes.lit","ERROR:ws_frame"]],0],["let","ws_payload",["std.net.ws.frame_payload_v1",["bytes.view","ws_frame"]]],["let","grpc_res",["std.net.grpc.msg_unprefix_v1",["bytes.view","grpc_frame"]]],["if",["!=",["result_bytes.err_code","grpc_res"],0],["return",["bytes.lit","ERROR:grpc_frame"]],0],["let","grpc_payload",["result_bytes.unwrap_or","grpc_res",["bytes.alloc",0]]],["let","resp",["std.vec.with_capacity",256]],["begin",["let","ws_len_le",["std.codec.write_u32_le",["bytes.len",["bytes.view","ws_payload"]]]],["set","resp",["std.vec.extend_bytes","resp",["bytes.view","ws_len_le"]]]],["set","resp",["std.vec.extend_bytes","resp",["bytes.view","ws_payload"]]],["begin",["let","grpc_len_le",["std.codec.write_u32_le",["bytes.len",["bytes.view","grpc_payload"]]]],["set","resp",["std.vec.extend_bytes","resp",["bytes.view","grpc_len_le"]]]],["set","resp",["std.vec.extend_bytes","resp",["bytes.view","grpc_payload"]]],["let","resp_b",["std.vec.as_bytes","resp"]],["let","wdoc",["begin",["let","h",["app._write_all_v1","stream",["bytes.view","resp_b"],["bytes.view","caps"]]],["task.spawn","h"],["await","h"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","wdoc"]],1],["return",["bytes.lit","ERROR:write"]],0],["std.net.tcp.stream_close_v1","stream"],["std.net.tcp.listener_close_v1","listener"],["bytes.lit","ok"]],"kind":"defasync","name":"app.server_v1","params":[{"name":"addr","ty":"bytes"},{"name":"caps","ty":"bytes"}],"result":"bytes"}],"imports":["std.bytes","std.codec","std.json","std.net.err","std.net.grpc","std.net.io","std.net.tcp","std.net.ws","std.vec"],"kind":"module","module_id":"app","schema_version":"x07.x07ast@0.4.0"}
