{"decls":[{"kind":"export","names":["gateway_tests.test_build_error_response","gateway_tests.test_canonicalize_header_already_lower","gateway_tests.test_canonicalize_header_lowercase","gateway_tests.test_normalize_path_add_slash","gateway_tests.test_normalize_path_dedup_slashes","gateway_tests.test_normalize_request_json","gateway_tests.test_pbt_header_canonicalize","gateway_tests.test_rr_fetch_upstream","gateway_tests.test_rr_health_check","gateway_tests.test_select_route_err","gateway_tests.test_select_route_valid","gateway_tests.test_shape_response_200"]},{"body":["begin",["let","msg",["bytes.lit","not_found"]],["let","result",["app.gateway.core.build_error_response_v1",404,["bytes.view","msg"]]],["let","qv",["std.vec.with_capacity",128]],["set","qv",["std.vec.extend_bytes","qv","result"]],["set","qv",["std.vec.push","qv",0]],["set","qv",["std.vec.extend_bytes","qv",["bytes.lit","status"]]],["let","query",["std.vec.as_bytes","qv"]],["let","extracted",["std.json.extract_path_canon_or_err",["bytes.view","query"]]],["let","expected_status",["bytes.lit","404"]],["try",["std.test.assert_bytes_eq","extracted","expected_status",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_build_error_response","params":[],"result":"result_i32"},{"body":["begin",["let","name",["bytes.lit","accept"]],["let","result",["app.gateway.core.canonicalize_header_name_v1",["bytes.view","name"]]],["let","expected",["bytes.lit","accept"]],["try",["std.test.assert_bytes_eq","result","expected",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_canonicalize_header_already_lower","params":[],"result":"result_i32"},{"body":["begin",["let","name",["bytes.lit","Content-Type"]],["let","result",["app.gateway.core.canonicalize_header_name_v1",["bytes.view","name"]]],["let","expected",["bytes.lit","content-type"]],["try",["std.test.assert_bytes_eq","result","expected",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_canonicalize_header_lowercase","params":[],"result":"result_i32"},{"body":["begin",["let","path",["bytes.lit","api/v1"]],["let","result",["app.gateway.core.normalize_path_v1",["bytes.view","path"]]],["let","expected",["bytes.lit","/api/v1"]],["try",["std.test.assert_bytes_eq","result","expected",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_normalize_path_add_slash","params":[],"result":"result_i32"},{"body":["begin",["let","path",["bytes.lit","//api///v1//"]],["let","result",["app.gateway.core.normalize_path_v1",["bytes.view","path"]]],["let","expected",["bytes.lit","/api/v1"]],["try",["std.test.assert_bytes_eq","result","expected",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_normalize_path_dedup_slashes","params":[],"result":"result_i32"},{"body":["begin",["let","method",["bytes.lit","POST"]],["let","path",["bytes.lit","/api/data"]],["let","body",["bytes.lit","hello"]],["let","result",["app.gateway.core.normalize_request_v1",["bytes.view","method"],["bytes.view","path"],["bytes.view","body"]]],["let","qv",["std.vec.with_capacity",128]],["set","qv",["std.vec.extend_bytes","qv","result"]],["set","qv",["std.vec.push","qv",0]],["set","qv",["std.vec.extend_bytes","qv",["bytes.lit","method"]]],["let","query",["std.vec.as_bytes","qv"]],["let","extracted",["std.json.extract_path_canon_or_err",["bytes.view","query"]]],["let","expected_method",["bytes.lit","\"POST\""]],["try",["std.test.assert_bytes_eq","extracted","expected_method",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_normalize_request_json","params":[],"result":"result_i32"},{"body":["begin",["let","n",["std.bytes.len","b"]],["if",["=","n",0],["std.test.status_from_result_i32",["std.test.pass"]],["begin",["let","result",["app.gateway.core.canonicalize_header_name_v1",["bytes.view","b"]]],["let","rlen",["std.bytes.len","result"]],["let","len_ok",["std.test.assert_i32_eq","rlen","n",["std.test.code_assert_i32_eq"]]],["if",["=",["result_i32.is_ok","len_ok"],0],["std.test.status_from_result_i32","len_ok"],["begin",["let","all_lower",1],["for","i",0,"rlen",["begin",["let","ch",["std.bytes.get_u8","result","i"]],["if",["if",[">=u","ch",65],["<=","ch",90],0],["set","all_lower",0],0]]],["std.test.status_from_result_i32",["std.test.assert_true","all_lower",["std.test.code_assert_true"]]]]]]]],"kind":"defn","name":"gateway_tests.test_pbt_header_canonicalize","params":[{"name":"b","ty":"bytes"}],"result":"bytes"},{"body":["std.rr.with_policy_v1",["bytes.lit","gw_rr_v1"],["bytes.lit","upstream_example.rrbin"],["i32.lit",2],["begin",["let","method",["bytes.lit","GET"]],["let","path",["bytes.lit","/api/items"]],["let","body",["bytes.lit",""]],["let","result",["app.gateway.upstream.rr.fetch_upstream_rr_v1",["bytes.view","method"],["bytes.view","path"],["bytes.view","body"]]],["try",["std.test.assert_true",["result_bytes.is_ok","result"],["std.test.code_assert_true"]]],["let","resp",["result_bytes.unwrap_or","result",["bytes.alloc",0]]],["try",["std.test.assert_true",[">",["view.len",["bytes.view","resp"]],0],["std.test.code_assert_true"]]],["std.test.pass"]]],"kind":"defn","name":"gateway_tests.test_rr_fetch_upstream","params":[],"result":"result_i32"},{"body":["begin",["let","result",["app.gateway.upstream.rr.health_check_rr_v1"]],["try",["std.test.assert_true",["result_bytes.is_ok","result"],["std.test.code_assert_true"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_rr_health_check","params":[],"result":"result_i32"},{"body":["begin",["let","bad_req",["bytes.lit","not json"]],["let","route_res",["app.gateway.core.select_route_v1",["bytes.view","bad_req"]]],["try",["std.test.assert_true",["=",["result_bytes.is_ok","route_res"],0],["std.test.code_assert_true"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_select_route_err","params":[],"result":"result_i32"},{"body":["begin",["let","method",["bytes.lit","GET"]],["let","path",["bytes.lit","/api/health"]],["let","body",["bytes.lit",""]],["let","norm_req",["app.gateway.core.normalize_request_v1",["bytes.view","method"],["bytes.view","path"],["bytes.view","body"]]],["let","route_res",["app.gateway.core.select_route_v1",["bytes.view","norm_req"]]],["try",["std.test.assert_true",["result_bytes.is_ok","route_res"],["std.test.code_assert_true"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_select_route_valid","params":[],"result":"result_i32"},{"body":["begin",["let","body",["bytes.lit","hello world"]],["let","result",["app.gateway.core.shape_response_v1",200,["bytes.view","body"]]],["let","qv",["std.vec.with_capacity",128]],["set","qv",["std.vec.extend_bytes","qv","result"]],["set","qv",["std.vec.push","qv",0]],["set","qv",["std.vec.extend_bytes","qv",["bytes.lit","status"]]],["let","query",["std.vec.as_bytes","qv"]],["let","extracted",["std.json.extract_path_canon_or_err",["bytes.view","query"]]],["let","expected_status",["bytes.lit","200"]],["try",["std.test.assert_bytes_eq","extracted","expected_status",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"gateway_tests.test_shape_response_200","params":[],"result":"result_i32"}],"imports":["app.gateway.core","app.gateway.os_main","app.gateway.upstream.rr","std.bytes","std.fmt","std.json","std.test","std.vec","std.rr"],"kind":"module","module_id":"gateway_tests","schema_version":"x07.x07ast@0.5.0"}
