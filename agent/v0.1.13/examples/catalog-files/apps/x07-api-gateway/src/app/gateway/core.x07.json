{"decls":[{"kind":"export","names":["app.gateway.core.build_error_response_v1","app.gateway.core.canonicalize_header_name_v1","app.gateway.core.normalize_path_v1","app.gateway.core.normalize_request_v1","app.gateway.core.select_route_v1","app.gateway.core.shape_response_v1"]},{"body":["begin",["let","v",["std.vec.with_capacity",128]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","{\"error\":\""]]],["set","v",["std.vec.extend_bytes","v",["view.to_bytes","msg"]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","\",\"status\":"]]],["set","v",["std.vec.extend_bytes","v",["std.fmt.u32_to_dec","code"]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","}"]]],["let","raw",["std.vec.as_bytes","v"]],["std.json.canonicalize_small",["bytes.view","raw"]]],"kind":"defn","name":"app.gateway.core.build_error_response_v1","params":[{"name":"code","ty":"i32"},{"name":"msg","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","name"]],["let","v",["std.vec.with_capacity","n"]],["for","i",0,"n",["begin",["let","ch",["view.get_u8","name","i"]],["if",["if",[">=u","ch",65],["<=","ch",90],0],["set","v",["std.vec.push","v",["+","ch",32]]],["set","v",["std.vec.push","v","ch"]]]]],["std.vec.as_bytes","v"]],"ensures":[{"expr":[">=",["view.len","name"],1],"id":"input_was_nonempty"}],"kind":"defn","name":"app.gateway.core.canonicalize_header_name_v1","params":[{"name":"name","ty":"bytes_view"}],"requires":[{"expr":[">",["view.len","name"],0],"id":"non_empty"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","path"]],["if",["=","n",0],["bytes.lit","/"],["begin",["let","first",["view.get_u8","path",0]],["if",["!=","first",47],["begin",["let","v",["std.vec.with_capacity",["+","n",1]]],["set","v",["std.vec.push","v",47]],["for","i",0,"n",["set","v",["std.vec.push","v",["view.get_u8","path","i"]]]],["std.vec.as_bytes","v"]],["begin",["let","v",["std.vec.with_capacity","n"]],["let","prev_slash",0],["for","i",0,"n",["begin",["let","ch",["view.get_u8","path","i"]],["if",["if",["=","ch",47],["=","prev_slash",1],0],0,["begin",["set","v",["std.vec.push","v","ch"]],0]],["set","prev_slash",["if",["=","ch",47],1,0]]]],["let","result",["std.vec.as_bytes","v"]],["let","rlen",["std.bytes.len","result"]],["if",["if",[">","rlen",1],["=",["std.bytes.get_u8","result",["-","rlen",1]],47],0],["std.bytes.take","result",["-","rlen",1]],"result"]]]]]],"ensures":[{"expr":[">=",["view.len","path"],1],"id":"input_was_nonempty"}],"kind":"defn","name":"app.gateway.core.normalize_path_v1","params":[{"name":"path","ty":"bytes_view"}],"requires":[{"expr":[">",["view.len","path"],0],"id":"non_empty_path"}],"result":"bytes"},{"body":["begin",["let","norm_path",["app.gateway.core.normalize_path_v1","path"]],["let","v",["std.vec.with_capacity",256]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","{\"method\":\""]]],["set","v",["std.vec.extend_bytes","v",["view.to_bytes","method"]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","\",\"path\":\""]]],["set","v",["std.vec.extend_bytes","v","norm_path"]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","\",\"body_len\":"]]],["set","v",["std.vec.extend_bytes","v",["std.fmt.u32_to_dec",["view.len","body"]]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","}"]]],["let","raw",["std.vec.as_bytes","v"]],["std.json.canonicalize_small",["bytes.view","raw"]]],"kind":"defn","name":"app.gateway.core.normalize_request_v1","params":[{"name":"method","ty":"bytes_view"},{"name":"path","ty":"bytes_view"},{"name":"body","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","qv",["std.vec.with_capacity",["+",["view.len","norm_req"],16]]],["set","qv",["std.vec.extend_bytes","qv",["view.to_bytes","norm_req"]]],["set","qv",["std.vec.push","qv",0]],["set","qv",["std.vec.extend_bytes","qv",["bytes.lit","path"]]],["let","query",["std.vec.as_bytes","qv"]],["let","extracted",["std.json.extract_path_canon_or_err",["bytes.view","query"]]],["let","_x07_tmp_borrow_decls_5_body_7_1_2",["bytes.lit","ERR"]],["if",["std.bytes.eq",["bytes.view","extracted"],["bytes.view","_x07_tmp_borrow_decls_5_body_7_1_2"]],["result_bytes.err",4001],["begin",["let","out",["std.vec.with_capacity",128]],["set","out",["std.vec.extend_bytes","out",["bytes.lit","{\"matched\":true,\"route\":"]]],["set","out",["std.vec.extend_bytes","out","extracted"]],["set","out",["std.vec.extend_bytes","out",["bytes.lit","}"]]],["let","raw",["std.vec.as_bytes","out"]],["result_bytes.ok",["std.json.canonicalize_small",["bytes.view","raw"]]]]]],"kind":"defn","name":"app.gateway.core.select_route_v1","params":[{"name":"norm_req","ty":"bytes_view"}],"result":"result_bytes"},{"body":["begin",["let","v",["std.vec.with_capacity",256]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","{\"body_len\":"]]],["set","v",["std.vec.extend_bytes","v",["std.fmt.u32_to_dec",["view.len","body"]]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit",",\"status\":"]]],["set","v",["std.vec.extend_bytes","v",["std.fmt.u32_to_dec","status"]]],["set","v",["std.vec.extend_bytes","v",["bytes.lit","}"]]],["let","raw",["std.vec.as_bytes","v"]],["std.json.canonicalize_small",["bytes.view","raw"]]],"kind":"defn","name":"app.gateway.core.shape_response_v1","params":[{"name":"status","ty":"i32"},{"name":"body","ty":"bytes_view"}],"result":"bytes"}],"imports":["std.bytes","std.fmt","std.json","std.text.ascii","std.vec","std.web.core","std.web.router"],"kind":"module","module_id":"app.gateway.core","schema_version":"x07.x07ast@0.5.0"}
