{"decls":[{"kind":"export","names":["app.main","app.test_error_state_v1","app.test_invalid_transition_v1","app.test_success_v1"]},{"body":["begin",["let","out",["std.vec.with_capacity",8]],["let","b0",["codec.write_u32_le","event_id"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b0"]]],["let","b1",["codec.write_u32_le",0]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b1"]]],["std.vec.as_bytes","out"]],"kind":"defn","name":"app._encode_event_v1","params":[{"name":"event_id","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","out",["std.vec.with_capacity",192]],["let","p_applied",["bytes.lit","{\"applied\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_applied"]]],["let","b_applied",["std.fmt.s32_to_dec","applied"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_applied"]]],["let","p_error_code",["bytes.lit",",\"error_code\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_error_code"]]],["let","b_error_code",["std.fmt.s32_to_dec","error_code"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_error_code"]]],["let","p_final_state",["bytes.lit",",\"final_state_id\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_final_state"]]],["let","b_final_state",["std.fmt.s32_to_dec","final_state_id"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_final_state"]]],["let","p_ok",["bytes.lit",",\"ok\":0}"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_ok"]]],["let","raw",["std.vec.as_bytes","out"]],["std.json.canonicalize_small",["bytes.view","raw"]]],"kind":"defn","name":"app._report_err_v1","params":[{"name":"applied","ty":"i32"},{"name":"final_state_id","ty":"i32"},{"name":"error_code","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","out",["std.vec.with_capacity",256]],["let","p_applied",["bytes.lit","{\"applied\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_applied"]]],["let","b_applied",["std.fmt.s32_to_dec","applied"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_applied"]]],["let","p_counts_fail",["bytes.lit",",\"counts\":{\"fail\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_counts_fail"]]],["let","b_fail",["std.fmt.s32_to_dec","count_fail"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_fail"]]],["let","p_finish",["bytes.lit",",\"finish\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_finish"]]],["let","b_finish",["std.fmt.s32_to_dec","count_finish"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_finish"]]],["let","p_start",["bytes.lit",",\"start\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_start"]]],["let","b_start",["std.fmt.s32_to_dec","count_start"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_start"]]],["let","p_tick",["bytes.lit",",\"tick\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_tick"]]],["let","b_tick",["std.fmt.s32_to_dec","count_tick"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_tick"]]],["let","p_final_state",["bytes.lit","},\"final_state_id\":"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_final_state"]]],["let","b_final_state",["std.fmt.s32_to_dec","final_state_id"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","b_final_state"]]],["let","p_ok",["bytes.lit",",\"ok\":1}"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","p_ok"]]],["let","raw",["std.vec.as_bytes","out"]],["std.json.canonicalize_small",["bytes.view","raw"]]],"kind":"defn","name":"app._report_ok_v1","params":[{"name":"applied","ty":"i32"},{"name":"final_state_id","ty":"i32"},{"name":"count_start","ty":"i32"},{"name":"count_tick","ty":"i32"},{"name":"count_finish","ty":"i32"},{"name":"count_fail","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","step_result"]],["if",["<u","n",8],["return",["result_bytes.err",10]],0],["let","ctx_len",["codec.read_u32_le","step_result",4]],["let","need",["+",8,"ctx_len"]],["if",["<u","n","need"],["return",["result_bytes.err",10]],0],["result_bytes.ok",["view.to_bytes",["view.slice","step_result",0,"need"]]]],"kind":"defn","name":"app._snapshot_from_step_result_v1","params":[{"name":"step_result","ty":"bytes_view"}],"result":"result_bytes"},{"body":["begin",["let","n",["view.len","snapshot"]],["if",["<u","n",4],["return",-1],0],["codec.read_u32_le","snapshot",0]],"kind":"defn","name":"app._state_id_from_snapshot_v1","params":[{"name":"snapshot","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","snapshot",["gen.sm.lifecycle_v1.init_v1"]],["let","applied",0],["let","count_start",0],["let","count_tick",0],["let","count_finish",0],["let","count_fail",0],["let","b_start",["bytes.lit","start"]],["let","v_start",["bytes.view","b_start"]],["let","b_tick",["bytes.lit","tick"]],["let","v_tick",["bytes.view","b_tick"]],["let","b_finish",["bytes.lit","finish"]],["let","v_finish",["bytes.view","b_finish"]],["let","b_fail",["bytes.lit","fail"]],["let","v_fail",["bytes.view","b_fail"]],["let","sl",["std.text.ascii.split_lines_view","event_lines"]],["let","slv",["bytes.view","sl"]],["let","n",["std.text.slices.count_v1","slv"]],["for","i",0,"n",["begin",["let","line",["std.text.slices.view_at_v1","event_lines","slv","i"]],["if",["=",["view.len","line"],0],0,["begin",["let","event_id",["if",["=",["std.bytes.eq","line","v_start"],1],0,["if",["=",["std.bytes.eq","line","v_tick"],1],1,["if",["=",["std.bytes.eq","line","v_finish"],1],2,["if",["=",["std.bytes.eq","line","v_fail"],1],3,-1]]]]],["if",["<","event_id",0],["return",["app._report_err_v1","applied",["app._state_id_from_snapshot_v1",["bytes.view","snapshot"]],100]],0],["if",["=","event_id",0],["set","count_start",["+","count_start",1]],["if",["=","event_id",1],["set","count_tick",["+","count_tick",1]],["if",["=","event_id",2],["set","count_finish",["+","count_finish",1]],["set","count_fail",["+","count_fail",1]]]]],["let","event",["app._encode_event_v1","event_id"]],["let","res",["budget.scope_from_arch_v1",["bytes.lit","sm_step_v1"],["gen.sm.lifecycle_v1.step_v1",["bytes.view","snapshot"],["bytes.view","event"]]]],["let","err",["result_bytes.err_code","res"]],["if",["!=","err",0],["return",["app._report_err_v1","applied",["app._state_id_from_snapshot_v1",["bytes.view","snapshot"]],"err"]],0],["let","step_result",["result_bytes.unwrap_or","res",["bytes.alloc",0]]],["let","snap_res",["app._snapshot_from_step_result_v1",["bytes.view","step_result"]]],["let","snap_err",["result_bytes.err_code","snap_res"]],["if",["!=","snap_err",0],["return",["app._report_err_v1","applied",["app._state_id_from_snapshot_v1",["bytes.view","snapshot"]],101]],0],["set","snapshot",["result_bytes.unwrap_or","snap_res",["bytes.alloc",0]]],["set","applied",["+","applied",1]],0]],0]],["app._report_ok_v1","applied",["app._state_id_from_snapshot_v1",["bytes.view","snapshot"]],"count_start","count_tick","count_finish","count_fail"]],"kind":"defn","name":"app.main","params":[{"name":"event_lines","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","in_bytes",["bytes.lit","start\nfail\n"]],["let","got",["app.main",["bytes.view","in_bytes"]]],["let","want",["bytes.lit","{\"applied\":2,\"counts\":{\"fail\":1,\"finish\":0,\"start\":1,\"tick\":0},\"final_state_id\":4,\"ok\":1}"]],["try",["std.test.assert_bytes_eq","got","want",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"app.test_error_state_v1","params":[],"result":"result_i32"},{"body":["begin",["let","in_bytes",["bytes.lit","tick\n"]],["let","got",["app.main",["bytes.view","in_bytes"]]],["let","want",["bytes.lit","{\"applied\":0,\"error_code\":3,\"final_state_id\":0,\"ok\":0}"]],["try",["std.test.assert_bytes_eq","got","want",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"app.test_invalid_transition_v1","params":[],"result":"result_i32"},{"body":["begin",["let","in_bytes",["bytes.lit","start\ntick\nfinish\n"]],["let","got",["app.main",["bytes.view","in_bytes"]]],["let","want",["bytes.lit","{\"applied\":3,\"counts\":{\"fail\":0,\"finish\":1,\"start\":1,\"tick\":1},\"final_state_id\":3,\"ok\":1}"]],["try",["std.test.assert_bytes_eq","got","want",["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"app.test_success_v1","params":[],"result":"result_i32"}],"imports":["gen.sm.lifecycle_v1","std.bytes","std.fmt","std.json","std.test","std.text.ascii","std.text.slices","std.vec"],"kind":"module","module_id":"app","schema_version":"x07.x07ast@0.4.0"}
