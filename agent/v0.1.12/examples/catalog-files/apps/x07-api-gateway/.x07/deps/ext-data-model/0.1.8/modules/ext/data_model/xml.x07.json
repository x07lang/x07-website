{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "ext.data_model.xml",
  "imports": ["ext.data_model", "ext.unicode"],
  "decls": [
    {
      "kind": "export",
      "names": ["ext.data_model.xml.emit_canon"]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._bytes_to_vec_u8",
      "params": [{"name": "b", "ty": "bytes_view"}],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "n", ["view.len", "b"]],
        ["let", "out", ["vec_u8.with_capacity", "n"]],
        ["for", "i", 0, "n", ["set", "out", ["vec_u8.push", "out", ["view.get_u8", "b", "i"]]]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._err_from_msg",
      "params": [{"name": "msg", "ty": "bytes_view"}],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_len", ["view.len", "msg"]],
        ["let", "out", ["vec_u8.with_capacity", ["+", 9, "msg_len"]]],
        ["set", "out", ["vec_u8.push", "out", 0]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", 0]]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", "msg_len"]]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["view.to_bytes", "msg"]]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._extend_view",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "b", "ty": "bytes_view"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "o", "out"],
        ["let", "n", ["view.len", "b"]],
        ["for", "i", 0, "n", ["set", "o", ["vec_u8.push", "o", ["view.get_u8", "b", "i"]]]],
        "o"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._is_xml_name_ok",
      "params": [{"name": "name", "ty": "bytes_view"}],
      "result": "i32",
      "body": [
        "begin",
        ["let", "n", ["view.len", "name"]],
        ["if", ["<", "n", 1], ["return", 0], 0],
        ["if", ["=", ["ext.unicode.unicode_utf8_is_valid", "name"], 0], ["return", 0], 0],
        [
          "for",
          "i",
          0,
          "n",
          [
            "begin",
            ["let", "c", ["view.get_u8", "name", "i"]],
            [
              "if",
              ["if", ["=", "c", 32], 1, ["if", ["=", "c", 9], 1, ["if", ["=", "c", 10], 1, ["=", "c", 13]]]],
              ["return", 0],
              0
            ],
            [
              "if",
              ["if", ["=", "c", 60], 1, ["if", ["=", "c", 62], 1, ["if", ["=", "c", 38], 1, ["if", ["=", "c", 34], 1, ["if", ["=", "c", 39], 1, ["if", ["=", "c", 47], 1, ["=", "c", 61]]]]]]],
              ["return", 0],
              0
            ],
            0
          ]
        ],
        1
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._append_escaped_text",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "text", "ty": "bytes_view"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "amp", ["bytes.lit", "&amp;"]],
        ["let", "lt", ["bytes.lit", "&lt;"]],
        ["let", "gt", ["bytes.lit", "&gt;"]],
        ["let", "o", "out"],
        ["let", "n", ["view.len", "text"]],
        [
          "for",
          "i",
          0,
          "n",
          [
            "begin",
            ["let", "c", ["view.get_u8", "text", "i"]],
            [
              "if",
              ["=", "c", 38],
              ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "amp"]]],
              [
                "if",
                ["=", "c", 60],
                ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "lt"]]],
                [
                  "if",
                  ["=", "c", 62],
                  ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "gt"]]],
                  ["set", "o", ["vec_u8.push", "o", "c"]]
                ]
              ]
            ],
            0
          ]
        ],
        "o"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._append_escaped_attr_value",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "val", "ty": "bytes_view"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "amp", ["bytes.lit", "&amp;"]],
        ["let", "lt", ["bytes.lit", "&lt;"]],
        ["let", "gt", ["bytes.lit", "&gt;"]],
        ["let", "quot", ["bytes.lit", "&quot;"]],
        ["let", "o", "out"],
        ["let", "n", ["view.len", "val"]],
        [
          "for",
          "i",
          0,
          "n",
          [
            "begin",
            ["let", "c", ["view.get_u8", "val", "i"]],
            [
              "if",
              ["=", "c", 38],
              ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "amp"]]],
              [
                "if",
                ["=", "c", 60],
                ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "lt"]]],
                [
                  "if",
                  ["=", "c", 62],
                  ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "gt"]]],
                  [
                    "if",
                    ["=", "c", 34],
                    ["set", "o", ["vec_u8.extend_bytes", "o", ["bytes.view", "quot"]]],
                    ["set", "o", ["vec_u8.push", "o", "c"]]
                  ]
                ]
              ]
            ],
            0
          ]
        ],
        "o"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._emit_node_into",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "doc", "ty": "bytes_view"},
        {"name": "off", "ty": "i32"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_invalid_node", ["bytes.lit", "data_model.xml:invalid_node"]],
        ["let", "tag", ["ext.data_model.kind_at", "doc", "off"]],
        ["if", ["<", "tag", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_node"]]], 0],
        [
          "if",
          ["=", "tag", 3],
          [
            "begin",
            ["let", "s", ["ext.data_model.string_get", "doc", "off"]],
            ["let", "sv", ["bytes.view", "s"]],
            ["if", ["=", ["ext.unicode.unicode_utf8_is_valid", "sv"], 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_node"]]], 0],
            ["ext.data_model.xml._append_escaped_text", "out", "sv"]
          ],
          [
            "if",
            ["=", "tag", 5],
            ["ext.data_model.xml._emit_element_into", "out", "doc", "off"],
            ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_node"]]
          ]
        ]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml._emit_element_into",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "doc", "ty": "bytes_view"},
        {"name": "off", "ty": "i32"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_root_not_map", ["bytes.lit", "data_model.xml:root_not_map"]],
        ["let", "msg_invalid_element", ["bytes.lit", "data_model.xml:invalid_element"]],
        ["let", "k_name", ["bytes.lit", "name"]],
        ["let", "k_attrs", ["bytes.lit", "attrs"]],
        ["let", "k_children", ["bytes.lit", "children"]],
        ["let", "name_off", ["ext.data_model.map_find", "doc", "off", ["bytes.view", "k_name"]]],
        ["if", ["<", "name_off", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["let", "attrs_off", ["ext.data_model.map_find", "doc", "off", ["bytes.view", "k_attrs"]]],
        ["if", ["<", "attrs_off", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["let", "children_off", ["ext.data_model.map_find", "doc", "off", ["bytes.view", "k_children"]]],
        ["if", ["<", "children_off", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["if", ["!=", ["ext.data_model.kind_at", "doc", "name_off"], 3], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["let", "name_b", ["ext.data_model.string_get", "doc", "name_off"]],
        ["let", "name", ["bytes.view", "name_b"]],
        ["if", ["=", ["ext.data_model.xml._is_xml_name_ok", "name"], 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["if", ["!=", ["ext.data_model.kind_at", "doc", "attrs_off"], 5], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_root_not_map"]]], 0],
        ["if", ["!=", ["ext.data_model.kind_at", "doc", "children_off"], 4], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        ["let", "o", "out"],
        ["set", "o", ["vec_u8.push", "o", 60]],
        ["set", "o", ["ext.data_model.xml._extend_view", "o", "name"]],
        ["let", "attr_n", ["ext.data_model.map_len", "doc", "attrs_off"]],
        ["if", ["<", "attr_n", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        [
          "for",
          "i",
          0,
          "attr_n",
          [
            "begin",
            ["let", "ak", ["ext.data_model.map_key_at", "doc", "attrs_off", "i"]],
            ["let", "akv", ["bytes.view", "ak"]],
            ["if", ["=", ["ext.data_model.xml._is_xml_name_ok", "akv"], 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
            ["let", "av_off", ["ext.data_model.map_value_at", "doc", "attrs_off", "i"]],
            ["if", ["<", "av_off", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
            ["if", ["!=", ["ext.data_model.kind_at", "doc", "av_off"], 3], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
            ["let", "avb", ["ext.data_model.string_get", "doc", "av_off"]],
            ["let", "av", ["bytes.view", "avb"]],
            ["if", ["=", ["ext.unicode.unicode_utf8_is_valid", "av"], 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
            ["set", "o", ["vec_u8.push", "o", 32]],
            ["set", "o", ["ext.data_model.xml._extend_view", "o", "akv"]],
            ["set", "o", ["vec_u8.push", "o", 61]],
            ["set", "o", ["vec_u8.push", "o", 34]],
            ["set", "o", ["ext.data_model.xml._append_escaped_attr_value", "o", "av"]],
            ["set", "o", ["vec_u8.push", "o", 34]],
            0
          ]
        ],
        ["let", "child_n", ["ext.data_model.seq_len", "doc", "children_off"]],
        ["if", ["<", "child_n", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
        [
          "if",
          ["=", "child_n", 0],
          [
            "begin",
            ["set", "o", ["vec_u8.push", "o", 47]],
            ["set", "o", ["vec_u8.push", "o", 62]],
            "o"
          ],
          [
            "begin",
            ["set", "o", ["vec_u8.push", "o", 62]],
            [
              "for",
              "i",
              0,
              "child_n",
              [
                "begin",
                ["let", "c_off", ["ext.data_model.seq_get", "doc", "children_off", "i"]],
                ["if", ["<", "c_off", 0], ["return", ["ext.data_model.xml._err_from_msg", ["bytes.view", "msg_invalid_element"]]], 0],
                ["set", "o", ["ext.data_model.xml._emit_node_into", "o", "doc", "c_off"]],
                ["if", ["=", ["vec_u8.get", "o", 0], 0], ["return", "o"], 0],
                0
              ]
            ],
            ["set", "o", ["vec_u8.push", "o", 60]],
            ["set", "o", ["vec_u8.push", "o", 47]],
            ["set", "o", ["ext.data_model.xml._extend_view", "o", "name"]],
            ["set", "o", ["vec_u8.push", "o", 62]],
            "o"
          ]
        ]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.xml.emit_canon",
      "params": [{"name": "doc", "ty": "bytes_view"}],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "msg_root_not_map", ["bytes.lit", "data_model.xml:root_not_map"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "doc"], 1], ["return", ["view.to_bytes", "doc"]], 0],
        ["if", ["!=", ["ext.data_model.root_kind", "doc"], 5], ["return", ["ext.data_model.doc_err_from_msg", ["bytes.view", "msg_root_not_map"]]], 0],
        ["let", "root_off", ["ext.data_model.root_offset", "doc"]],
        ["if", ["<", "root_off", 0], ["return", ["ext.data_model.doc_err_from_msg", ["bytes.view", "msg_root_not_map"]]], 0],
        ["let", "out", ["vec_u8.with_capacity", ["+", 32, ["view.len", "doc"]]]],
        ["set", "out", ["ext.data_model.xml._emit_element_into", "out", "doc", "root_off"]],
        ["if", ["=", ["vec_u8.get", "out", 0], 0], ["return", ["vec_u8.into_bytes", "out"]], 0],
        ["let", "xml_bytes", ["vec_u8.into_bytes", "out"]],
        ["ext.data_model.doc_ok", ["bytes.view", "xml_bytes"]]
      ]
    }
  ]
}
