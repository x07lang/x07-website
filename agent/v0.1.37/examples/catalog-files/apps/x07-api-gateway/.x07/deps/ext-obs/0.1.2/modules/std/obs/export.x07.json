{"decls":[{"kind":"export","names":["std.obs.export.otlp_http_export_from_arch_v1"]},{"body":["begin",["let","root",["ext.data_model.root_offset","idx"]],["let","k_defaults",["bytes.lit","defaults"]],["let","defaults_off",["ext.data_model.map_find","idx","root",["bytes.view","k_defaults"]]],["if",["<","defaults_off",0],["return",["bytes.alloc",0]],0],["let","k_id",["bytes.lit","default_exporter_id"]],["let","id_off",["ext.data_model.map_find","idx","defaults_off",["bytes.view","k_id"]]],["if",["<","id_off",0],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","idx","id_off"]],"kind":"defn","name":"std.obs.export._default_exporter_id_v1","params":[{"name":"idx","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","eid",["view.to_bytes","exporter_id"]],["let","root",["ext.data_model.root_offset","idx"]],["let","k_exporters",["bytes.lit","exporters"]],["let","exporters_off",["ext.data_model.map_find","idx","root",["bytes.view","k_exporters"]]],["if",["<","exporters_off",0],["return",-1],0],["let","n",["ext.data_model.seq_len","idx","exporters_off"]],["if",["<","n",0],["return",-1],0],["let","found",-1],["let","k_id_key",["bytes.lit","id"]],["for","i",0,"n",["if",["<","found",0],["begin",["let","e_off",["ext.data_model.seq_get","idx","exporters_off","i"]],["if",["<","e_off",0],0,["begin",["let","id_off",["ext.data_model.map_find","idx","e_off",["bytes.view","k_id_key"]]],["if",["<","id_off",0],0,["begin",["let","id",["ext.data_model.string_get","idx","id_off"]],["if",["bytes.eq","id","eid"],["set","found","e_off"],0],0]],0]],0],0]],"found"],"kind":"defn","name":"std.obs.export._find_exporter_ref_off_v1","params":[{"name":"idx","ty":"bytes_view"},{"name":"exporter_id","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","b"]],["if",["<=","n",0],["return",-1],0],["let","x",0],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["if",["if",[">=u","c",48],["<u","c",58],0],0,["return",-1]],["let","d",["-","c",48]],["if",[">","x",214748364],["return",-1],0],["if",["if",["=","x",214748364],[">","d",7],0],["return",-1],0],["set","x",["+",["*","x",10],"d"]],0]],"x"],"kind":"defn","name":"std.obs.export._parse_u32_dec_or_neg1_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","b",["os.fs.read_file","path"]],["ext.json.data_model.parse",["bytes.view","b"]]],"kind":"defn","name":"std.obs.export._read_json_doc_v1","params":[{"name":"path","ty":"bytes"}],"result":"bytes"},{"body":["budget.scope_from_arch_v1",["bytes.lit","obs_export_v1"],["begin",["let","payload_res",["std.obs.otlp.encode_metrics_export_v1","snapshot"]],["if",["!=",["result_bytes.err_code","payload_res"],0],["return",["result_i32.err",["+",64020,["result_bytes.err_code","payload_res"]]]],0],["let","payload",["result_bytes.unwrap_or","payload_res",["bytes.alloc",0]]],["let","idx_doc",["std.obs.export._read_json_doc_v1",["bytes.lit","arch/obs/index.x07obs.json"]]],["let","idx",["bytes.view","idx_doc"]],["if",["=",["ext.data_model.doc_is_err","idx"],1],["return",["result_i32.err",64001]],0],["let","eid",["if",[">",["view.len","exporter_id"],0],["view.to_bytes","exporter_id"],["std.obs.export._default_exporter_id_v1","idx"]]],["if",["=",["bytes.len","eid"],0],["return",["result_i32.err",64002]],0],["let","e_off",["std.obs.export._find_exporter_ref_off_v1","idx",["bytes.view","eid"]]],["if",["<","e_off",0],["return",["result_i32.err",64003]],0],["let","k_profile_path",["bytes.lit","profile_path"]],["let","path_off",["ext.data_model.map_find","idx","e_off",["bytes.view","k_profile_path"]]],["if",["<","path_off",0],["return",["result_i32.err",64004]],0],["let","profile_path",["ext.data_model.string_get","idx","path_off"]],["if",["=",["bytes.len","profile_path"],0],["return",["result_i32.err",64005]],0],["let","prof_doc",["std.obs.export._read_json_doc_v1","profile_path"]],["let","prof",["bytes.view","prof_doc"]],["if",["=",["ext.data_model.doc_is_err","prof"],1],["return",["result_i32.err",64006]],0],["let","root",["ext.data_model.root_offset","prof"]],["let","k_schema",["bytes.lit","schema_version"]],["let","schema_off",["ext.data_model.map_find","prof","root",["bytes.view","k_schema"]]],["if",["<","schema_off",0],["return",["result_i32.err",64007]],0],["let","schema",["ext.data_model.string_get","prof","schema_off"]],["if",["bytes.eq","schema",["bytes.lit","x07.obs.exporter.profile@0.1.0"]],0,["return",["result_i32.err",64008]]],["let","k_kind",["bytes.lit","kind"]],["let","kind_off",["ext.data_model.map_find","prof","root",["bytes.view","k_kind"]]],["if",["<","kind_off",0],["return",["result_i32.err",64009]],0],["let","kind",["ext.data_model.string_get","prof","kind_off"]],["if",["bytes.eq","kind",["bytes.lit","otlp_http_protobuf_v1"]],0,["return",["result_i32.err",64010]]],["let","k_cfg",["bytes.lit","cfg"]],["let","cfg_off",["ext.data_model.map_find","prof","root",["bytes.view","k_cfg"]]],["if",["<","cfg_off",0],["return",["result_i32.err",64011]],0],["let","k_endpoint",["bytes.lit","endpoint"]],["let","endpoint_off",["ext.data_model.map_find","prof","cfg_off",["bytes.view","k_endpoint"]]],["if",["<","endpoint_off",0],["return",["result_i32.err",64012]],0],["let","endpoint",["ext.data_model.string_get","prof","endpoint_off"]],["if",["=",["bytes.len","endpoint"],0],["return",["result_i32.err",64013]],0],["let","timeout_ms",5000],["let","k_timeout",["bytes.lit","timeout_ms"]],["let","timeout_off",["ext.data_model.map_find","prof","cfg_off",["bytes.view","k_timeout"]]],["if",[">=","timeout_off",0],["begin",["let","n",["ext.data_model.number_get","prof","timeout_off"]],["let","x",["std.obs.export._parse_u32_dec_or_neg1_v1",["bytes.view","n"]]],["if",["<","x",0],["return",["result_i32.err",64014]],0],["set","timeout_ms","x"],0],0],["let","max_body_bytes",1048576],["let","k_max_body",["bytes.lit","max_body_bytes"]],["let","max_body_off",["ext.data_model.map_find","prof","cfg_off",["bytes.view","k_max_body"]]],["if",[">=","max_body_off",0],["begin",["let","n",["ext.data_model.number_get","prof","max_body_off"]],["let","x",["std.obs.export._parse_u32_dec_or_neg1_v1",["bytes.view","n"]]],["if",["<","x",0],["return",["result_i32.err",64015]],0],["set","max_body_bytes","x"],0],0],["if",["<","max_body_bytes",0],["return",["result_i32.err",64016]],0],["if",[">",["bytes.len","payload"],"max_body_bytes"],["return",["result_i32.err",64017]],0],["let","headers",["std.net.http.spec.headers_empty_v1"]],["let","k_headers",["bytes.lit","headers"]],["let","headers_off",["ext.data_model.map_find","prof","cfg_off",["bytes.view","k_headers"]]],["if",[">=","headers_off",0],["begin",["let","hlen",["ext.data_model.seq_len","prof","headers_off"]],["if",["<","hlen",0],["return",["result_i32.err",64018]],0],["let","k_k",["bytes.lit","k"]],["let","k_v",["bytes.lit","v"]],["for","i",0,"hlen",["begin",["let","h_off",["ext.data_model.seq_get","prof","headers_off","i"]],["if",["<","h_off",0],["return",["result_i32.err",64019]],0],["let","hk_off",["ext.data_model.map_find","prof","h_off",["bytes.view","k_k"]]],["let","hv_off",["ext.data_model.map_find","prof","h_off",["bytes.view","k_v"]]],["if",["if",["<","hk_off",0],1,["<","hv_off",0]],["return",["result_i32.err",64019]],0],["let","hk",["ext.data_model.string_get","prof","hk_off"]],["let","hv",["ext.data_model.string_get","prof","hv_off"]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hk"],["bytes.view","hv"]]],0]],0],0],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.lit","content-type"],["bytes.lit","application/x-protobuf"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.lit","accept"],["bytes.lit","application/x-protobuf"]]],["let","timeout_s",["/",["+","timeout_ms",999],1000]],["if",["<","timeout_s",1],["set","timeout_s",1],0],["let","caps",["std.net.http.spec.caps_v1",0,"timeout_s",0,4096,64,"max_body_bytes"]],["let","req",["std.net.http.spec.req_post_v1",["bytes.view","endpoint"],["bytes.view","headers"],["bytes.view","payload"],["bytes.view","caps"]]],["let","resp",["std.net.http.client.fetch_v1","req"]],["let","rv",["bytes.view","resp"]],["if",["=",["std.net.http.client.resp_is_err_v1","rv"],1],["begin",["let","code",["std.net.http.client.resp_err_code_v1","rv"]],["result_i32.err",["+",64100,"code"]]],["begin",["let","status",["std.net.http.client.resp_status_v1","rv"]],["if",["if",[">=u","status",200],["<u","status",300],0],["result_i32.ok",0],["result_i32.err",["+",65000,"status"]]]]]]],"kind":"defn","name":"std.obs.export.otlp_http_export_from_arch_v1","params":[{"name":"exporter_id","ty":"bytes_view"},{"name":"snapshot","ty":"bytes_view"}],"result":"result_i32"}],"imports":["ext.data_model","ext.json.data_model","std.net.http.client","std.net.http.spec","std.obs.otlp"],"kind":"module","module_id":"std.obs.export","schema_version":"x07.x07ast@0.3.0"}
