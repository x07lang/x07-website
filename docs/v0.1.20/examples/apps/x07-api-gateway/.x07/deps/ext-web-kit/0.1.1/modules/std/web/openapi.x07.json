{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.web.openapi",
  "imports": [
    "ext.data_model",
    "ext.data_model.json",
    "ext.json.data_model",
    "std.bytes",
    "std.fs",
    "std.u32",
    "std.web.core",
    "std.vec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.web.openapi.render_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.web.openapi._read_index_doc_v1",
      "params": [],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "path", ["bytes.lit", "arch/web/index.x07web.json"]],
        ["let", "raw", ["std.fs.read", ["bytes.view", "path"]]],
        ["ext.json.data_model.parse", ["bytes.view", "raw"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.web.openapi._find_api_ref_field_v1",
      "params": [
        { "name": "index_doc", "ty": "bytes_view" },
        { "name": "api_id", "ty": "bytes_view" },
        { "name": "field", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "root", ["ext.data_model.root_offset", "index_doc"]],
        ["let", "k_apis", ["bytes.lit", "apis"]],
        ["let", "apis_off", ["ext.data_model.map_find", "index_doc", "root", ["bytes.view", "k_apis"]]],
        ["if", ["<", "apis_off", 0], ["return", ["bytes.alloc", 0]], 0],
        ["let", "count", ["ext.data_model.seq_len", "index_doc", "apis_off"]],
        ["if", ["<", "count", 0], ["return", ["bytes.alloc", 0]], 0],
        ["let", "k_id", ["bytes.lit", "id"]],
        [
          "for",
          "i",
          0,
          "count",
          [
            "begin",
            ["let", "ref_off", ["ext.data_model.seq_get", "index_doc", "apis_off", "i"]],
            ["if", ["<", "ref_off", 0], 0, ["begin",
              ["let", "id_off", ["ext.data_model.map_find", "index_doc", "ref_off", ["bytes.view", "k_id"]]],
              ["if", ["<", "id_off", 0], 0, ["begin",
                ["let", "id_b", ["ext.data_model.string_get", "index_doc", "id_off"]],
                ["if", ["=", ["std.bytes.eq", ["bytes.view", "id_b"], "api_id"], 1],
                  ["begin",
                    ["let", "val_off", ["ext.data_model.map_find", "index_doc", "ref_off", "field"]],
                    ["if", ["<", "val_off", 0], ["return", ["bytes.alloc", 0]], 0],
                    ["return", ["ext.data_model.string_get", "index_doc", "val_off"]]
                  ],
                  0
                ]
              ]]
            ]],
            0
          ]
        ],
        ["bytes.alloc", 0]
      ]
    },
    {
      "kind": "defn",
      "name": "std.web.openapi._method_lower_v1",
      "params": [{ "name": "method", "ty": "bytes_view" }],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "n", ["view.len", "method"]],
        ["let", "out", ["vec_u8.with_capacity", "n"]],
        [
          "for",
          "i",
          0,
          "n",
          [
            "begin",
            ["let", "c", ["view.get_u8", "method", "i"]],
            ["if", ["if", [">=u", "c", 65], ["<u", "c", 91], 0], ["set", "out", ["vec_u8.push", "out", ["+", "c", 32]]], ["set", "out", ["vec_u8.push", "out", "c"]]],
            0
          ]
        ],
        ["vec_u8.into_bytes", "out"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.web.openapi.render_v1",
      "params": [{ "name": "api_id", "ty": "bytes_view" }],
      "result": "result_bytes",
      "body": [
        "budget.scope_from_arch_v1",
        ["bytes.lit", "web_core_v1"],
        [
          "begin",
          ["let", "index_doc", ["std.web.openapi._read_index_doc_v1"]],
          ["let", "idxv", ["bytes.view", "index_doc"]],
          ["if", ["=", ["ext.data_model.doc_is_err", "idxv"], 1], ["return", ["result_bytes.err", 9101]], 0],
          ["let", "k_api_path", ["bytes.lit", "api_path"]],
          ["let", "k_openapi_path", ["bytes.lit", "openapi_profile_path"]],
          ["let", "api_path", ["std.web.openapi._find_api_ref_field_v1", "idxv", "api_id", ["bytes.view", "k_api_path"]]],
          ["if", ["=", ["bytes.len", "api_path"], 0], ["return", ["result_bytes.err", 9102]], 0],
          ["let", "openapi_path", ["std.web.openapi._find_api_ref_field_v1", "idxv", "api_id", ["bytes.view", "k_openapi_path"]]],
          ["if", ["=", ["bytes.len", "openapi_path"], 0], ["return", ["result_bytes.err", 9103]], 0],
          ["let", "raw_api", ["std.fs.read", ["bytes.view", "api_path"]]],
          ["let", "api_doc", ["ext.json.data_model.parse", ["bytes.view", "raw_api"]]],
          ["let", "apiv", ["bytes.view", "api_doc"]],
          ["if", ["=", ["ext.data_model.doc_is_err", "apiv"], 1], ["return", ["result_bytes.err", 9104]], 0],
          ["let", "raw_prof", ["std.fs.read", ["bytes.view", "openapi_path"]]],
          ["let", "prof_doc", ["ext.json.data_model.parse", ["bytes.view", "raw_prof"]]],
          ["let", "profv", ["bytes.view", "prof_doc"]],
          ["if", ["=", ["ext.data_model.doc_is_err", "profv"], 1], ["return", ["result_bytes.err", 9105]], 0],
          ["let", "prof_root", ["ext.data_model.root_offset", "profv"]],
          ["let", "k_oas", ["bytes.lit", "oas"]],
          ["let", "k_title", ["bytes.lit", "title"]],
          ["let", "k_version", ["bytes.lit", "version"]],
          ["let", "k_dialect", ["bytes.lit", "json_schema_dialect"]],
          ["let", "oas_off", ["ext.data_model.map_find", "profv", "prof_root", ["bytes.view", "k_oas"]]],
          ["let", "title_off", ["ext.data_model.map_find", "profv", "prof_root", ["bytes.view", "k_title"]]],
          ["let", "ver_off", ["ext.data_model.map_find", "profv", "prof_root", ["bytes.view", "k_version"]]],
          ["let", "dialect_off", ["ext.data_model.map_find", "profv", "prof_root", ["bytes.view", "k_dialect"]]],
          ["if", ["if", ["<", "oas_off", 0], 1, ["if", ["<", "title_off", 0], 1, ["if", ["<", "ver_off", 0], 1, ["<", "dialect_off", 0]]]], ["return", ["result_bytes.err", 9106]], 0],
          ["let", "oas", ["ext.data_model.string_get", "profv", "oas_off"]],
          ["let", "title", ["ext.data_model.string_get", "profv", "title_off"]],
          ["let", "ver", ["ext.data_model.string_get", "profv", "ver_off"]],
          ["let", "dialect", ["ext.data_model.string_get", "profv", "dialect_off"]],
          ["let", "api_root", ["ext.data_model.root_offset", "apiv"]],
          ["let", "k_endpoints", ["bytes.lit", "endpoints"]],
          ["let", "eps_off", ["ext.data_model.map_find", "apiv", "api_root", ["bytes.view", "k_endpoints"]]],
          ["if", ["<", "eps_off", 0], ["return", ["result_bytes.err", 9107]], 0],
          ["let", "ep_count", ["ext.data_model.seq_len", "apiv", "eps_off"]],
          ["if", ["<", "ep_count", 0], ["return", ["result_bytes.err", 9107]], 0],
          ["let", "paths_entries", ["std.vec.with_capacity", 512]],
          ["set", "paths_entries", ["std.u32.push_le", "paths_entries", "ep_count"]],
          ["let", "k_ep_id", ["bytes.lit", "id"]],
          ["let", "k_ep_method", ["bytes.lit", "method"]],
          ["let", "k_ep_path", ["bytes.lit", "path"]],
          [
            "for",
            "i",
            0,
            "ep_count",
            [
              "begin",
              ["let", "ep_off", ["ext.data_model.seq_get", "apiv", "eps_off", "i"]],
              ["if", ["<", "ep_off", 0], ["return", ["result_bytes.err", 9108]], 0],
              ["let", "id_off2", ["ext.data_model.map_find", "apiv", "ep_off", ["bytes.view", "k_ep_id"]]],
              ["let", "m_off2", ["ext.data_model.map_find", "apiv", "ep_off", ["bytes.view", "k_ep_method"]]],
              ["let", "p_off2", ["ext.data_model.map_find", "apiv", "ep_off", ["bytes.view", "k_ep_path"]]],
              ["if", ["if", ["<", "id_off2", 0], 1, ["if", ["<", "m_off2", 0], 1, ["<", "p_off2", 0]]], ["return", ["result_bytes.err", 9108]], 0],
              ["let", "ep_id", ["ext.data_model.string_get", "apiv", "id_off2"]],
              ["let", "ep_method", ["ext.data_model.string_get", "apiv", "m_off2"]],
              ["let", "ep_path", ["ext.data_model.string_get", "apiv", "p_off2"]],
              ["let", "m_lower", ["std.web.openapi._method_lower_v1", ["bytes.view", "ep_method"]]],
              ["let", "k_opid", ["bytes.lit", "operationId"]],
              ["let", "k_responses", ["bytes.lit", "responses"]],
              ["let", "k_200", ["bytes.lit", "200"]],
              ["let", "k_desc", ["bytes.lit", "description"]],
              ["let", "ok", ["bytes.lit", "OK"]],
              ["let", "v_ok", ["ext.data_model.value_string", ["bytes.view", "ok"]]],
              ["let", "resp_entries", ["std.vec.with_capacity", 64]],
              ["set", "resp_entries", ["std.u32.push_le", "resp_entries", 1]],
              ["set", "resp_entries", ["std.u32.push_le", "resp_entries", ["bytes.len", "k_desc"]]],
              ["set", "resp_entries", ["std.vec.extend_bytes", "resp_entries", ["bytes.view", "k_desc"]]],
              ["set", "resp_entries", ["std.u32.push_le", "resp_entries", ["bytes.len", "v_ok"]]],
              ["set", "resp_entries", ["std.vec.extend_bytes", "resp_entries", ["bytes.view", "v_ok"]]],
              ["let", "resp_entries_b", ["std.vec.as_bytes", "resp_entries"]],
              ["let", "resp200_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "resp_entries_b"]]],
              ["if", ["=", ["bytes.len", "resp200_val"], 0], ["return", ["result_bytes.err", 9109]], 0],
              ["let", "responses_entries", ["std.vec.with_capacity", 96]],
              ["set", "responses_entries", ["std.u32.push_le", "responses_entries", 1]],
              ["set", "responses_entries", ["std.u32.push_le", "responses_entries", ["bytes.len", "k_200"]]],
              ["set", "responses_entries", ["std.vec.extend_bytes", "responses_entries", ["bytes.view", "k_200"]]],
              ["set", "responses_entries", ["std.u32.push_le", "responses_entries", ["bytes.len", "resp200_val"]]],
              ["set", "responses_entries", ["std.vec.extend_bytes", "responses_entries", ["bytes.view", "resp200_val"]]],
              ["let", "responses_entries_b", ["std.vec.as_bytes", "responses_entries"]],
              ["let", "responses_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "responses_entries_b"]]],
              ["if", ["=", ["bytes.len", "responses_val"], 0], ["return", ["result_bytes.err", 9110]], 0],
              ["let", "op_entries", ["std.vec.with_capacity", 128]],
              ["set", "op_entries", ["std.u32.push_le", "op_entries", 2]],
              ["let", "v_epid", ["ext.data_model.value_string", ["bytes.view", "ep_id"]]],
              ["set", "op_entries", ["std.u32.push_le", "op_entries", ["bytes.len", "k_opid"]]],
              ["set", "op_entries", ["std.vec.extend_bytes", "op_entries", ["bytes.view", "k_opid"]]],
              ["set", "op_entries", ["std.u32.push_le", "op_entries", ["bytes.len", "v_epid"]]],
              ["set", "op_entries", ["std.vec.extend_bytes", "op_entries", ["bytes.view", "v_epid"]]],
              ["set", "op_entries", ["std.u32.push_le", "op_entries", ["bytes.len", "k_responses"]]],
              ["set", "op_entries", ["std.vec.extend_bytes", "op_entries", ["bytes.view", "k_responses"]]],
              ["set", "op_entries", ["std.u32.push_le", "op_entries", ["bytes.len", "responses_val"]]],
              ["set", "op_entries", ["std.vec.extend_bytes", "op_entries", ["bytes.view", "responses_val"]]],
              ["let", "op_entries_b", ["std.vec.as_bytes", "op_entries"]],
              ["let", "op_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "op_entries_b"]]],
              ["if", ["=", ["bytes.len", "op_val"], 0], ["return", ["result_bytes.err", 9111]], 0],
              ["let", "methods_entries", ["std.vec.with_capacity", 128]],
              ["set", "methods_entries", ["std.u32.push_le", "methods_entries", 1]],
              ["set", "methods_entries", ["std.u32.push_le", "methods_entries", ["bytes.len", "m_lower"]]],
              ["set", "methods_entries", ["std.vec.extend_bytes", "methods_entries", ["bytes.view", "m_lower"]]],
              ["set", "methods_entries", ["std.u32.push_le", "methods_entries", ["bytes.len", "op_val"]]],
              ["set", "methods_entries", ["std.vec.extend_bytes", "methods_entries", ["bytes.view", "op_val"]]],
              ["let", "methods_entries_b", ["std.vec.as_bytes", "methods_entries"]],
              ["let", "methods_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "methods_entries_b"]]],
              ["if", ["=", ["bytes.len", "methods_val"], 0], ["return", ["result_bytes.err", 9112]], 0],
              ["set", "paths_entries", ["std.u32.push_le", "paths_entries", ["bytes.len", "ep_path"]]],
              ["set", "paths_entries", ["std.vec.extend_bytes", "paths_entries", ["bytes.view", "ep_path"]]],
              ["set", "paths_entries", ["std.u32.push_le", "paths_entries", ["bytes.len", "methods_val"]]],
              ["set", "paths_entries", ["std.vec.extend_bytes", "paths_entries", ["bytes.view", "methods_val"]]],
              0
            ]
          ],
          ["let", "paths_entries_b", ["std.vec.as_bytes", "paths_entries"]],
          ["let", "paths_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "paths_entries_b"]]],
          ["if", ["=", ["bytes.len", "paths_val"], 0], ["return", ["result_bytes.err", 9113]], 0],
          ["let", "k_openapi", ["bytes.lit", "openapi"]],
          ["let", "k_info", ["bytes.lit", "info"]],
          ["let", "k_paths", ["bytes.lit", "paths"]],
          ["let", "k_jsd", ["bytes.lit", "jsonSchemaDialect"]],
          ["let", "k_title2", ["bytes.lit", "title"]],
          ["let", "k_version2", ["bytes.lit", "version"]],
          ["let", "info_entries", ["std.vec.with_capacity", 128]],
          ["set", "info_entries", ["std.u32.push_le", "info_entries", 2]],
          ["let", "v_title", ["ext.data_model.value_string", ["bytes.view", "title"]]],
          ["let", "v_ver", ["ext.data_model.value_string", ["bytes.view", "ver"]]],
          ["set", "info_entries", ["std.u32.push_le", "info_entries", ["bytes.len", "k_title2"]]],
          ["set", "info_entries", ["std.vec.extend_bytes", "info_entries", ["bytes.view", "k_title2"]]],
          ["set", "info_entries", ["std.u32.push_le", "info_entries", ["bytes.len", "v_title"]]],
          ["set", "info_entries", ["std.vec.extend_bytes", "info_entries", ["bytes.view", "v_title"]]],
          ["set", "info_entries", ["std.u32.push_le", "info_entries", ["bytes.len", "k_version2"]]],
          ["set", "info_entries", ["std.vec.extend_bytes", "info_entries", ["bytes.view", "k_version2"]]],
          ["set", "info_entries", ["std.u32.push_le", "info_entries", ["bytes.len", "v_ver"]]],
          ["set", "info_entries", ["std.vec.extend_bytes", "info_entries", ["bytes.view", "v_ver"]]],
          ["let", "info_entries_b", ["std.vec.as_bytes", "info_entries"]],
          ["let", "info_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "info_entries_b"]]],
          ["if", ["=", ["bytes.len", "info_val"], 0], ["return", ["result_bytes.err", 9114]], 0],
          ["let", "root_entries", ["std.vec.with_capacity", 256]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", 4]],
          ["let", "v_openapi", ["ext.data_model.value_string", ["bytes.view", "oas"]]],
          ["let", "v_jsd", ["ext.data_model.value_string", ["bytes.view", "dialect"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "k_info"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "k_info"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "info_val"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "info_val"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "k_jsd"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "k_jsd"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "v_jsd"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "v_jsd"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "k_openapi"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "k_openapi"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "v_openapi"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "v_openapi"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "k_paths"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "k_paths"]]],
          ["set", "root_entries", ["std.u32.push_le", "root_entries", ["bytes.len", "paths_val"]]],
          ["set", "root_entries", ["std.vec.extend_bytes", "root_entries", ["bytes.view", "paths_val"]]],
          ["let", "root_entries_b", ["std.vec.as_bytes", "root_entries"]],
          ["let", "root_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "root_entries_b"]]],
          ["if", ["=", ["bytes.len", "root_val"], 0], ["return", ["result_bytes.err", 9115]], 0],
          ["let", "doc", ["ext.data_model.doc_ok", ["bytes.view", "root_val"]]],
          ["let", "json_doc", ["ext.data_model.json.emit_canon", ["bytes.view", "doc"]]],
          ["if", ["=", ["ext.data_model.doc_is_err", ["bytes.view", "json_doc"]], 1], ["return", ["result_bytes.err", 9116]], 0],
          ["let", "payload", ["std.web.core.doc_get_bytes_v1", ["bytes.view", "json_doc"]]],
          ["let", "out", ["std.vec.with_capacity", ["+", ["bytes.len", "payload"], 1]]],
          ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "payload"]]],
          ["set", "out", ["std.vec.push", "out", 10]],
          ["result_bytes.ok", ["std.vec.as_bytes", "out"]]
        ]
      ]
    }
  ]
}
