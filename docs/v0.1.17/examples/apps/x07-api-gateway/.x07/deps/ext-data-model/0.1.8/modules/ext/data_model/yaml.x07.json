{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "ext.data_model.yaml",
  "imports": ["ext.data_model", "ext.data_model.json"],
  "decls": [
    {
      "kind": "export",
      "names": ["ext.data_model.yaml.emit_canon"]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._bytes_to_vec_u8",
      "params": [{"name": "b", "ty": "bytes_view"}],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "n", ["view.len", "b"]],
        ["let", "out", ["vec_u8.with_capacity", "n"]],
        ["for", "i", 0, "n", ["set", "out", ["vec_u8.push", "out", ["view.get_u8", "b", "i"]]]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._err_from_msg",
      "params": [{"name": "msg", "ty": "bytes_view"}],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_len", ["view.len", "msg"]],
        ["let", "out", ["vec_u8.with_capacity", ["+", 9, "msg_len"]]],
        ["set", "out", ["vec_u8.push", "out", 0]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", 0]]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", "msg_len"]]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["view.to_bytes", "msg"]]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._indent",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "n", "ty": "i32"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "o", "out"],
        ["for", "_", 0, "n", ["set", "o", ["vec_u8.push", "o", 32]]],
        "o"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._extend_view",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "b", "ty": "bytes_view"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "o", "out"],
        ["let", "n", ["view.len", "b"]],
        ["for", "i", 0, "n", ["set", "o", ["vec_u8.push", "o", ["view.get_u8", "b", "i"]]]],
        "o"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._ensure_trailing_newline",
      "params": [{"name": "out", "ty": "vec_u8"}],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "o", "out"],
        ["let", "n", ["view.len", ["vec_u8.as_view", "o"]]],
        ["if", ["=", "n", 0], ["return", "o"], 0],
        ["let", "last", ["view.get_u8", ["vec_u8.as_view", "o"], ["-", "n", 1]]],
        ["if", ["=", "last", 10], "o", ["vec_u8.push", "o", 10]]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._append_scalar_json_payload",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "doc", "ty": "bytes_view"},
        {"name": "off", "ty": "i32"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_invalid_value", ["bytes.lit", "data_model.yaml:invalid_value"]],
        ["let", "msg_invalid_bool", ["bytes.lit", "data_model.yaml:invalid_bool"]],
        ["let", "msg_invalid_number", ["bytes.lit", "data_model.yaml:invalid_number"]],
        ["let", "msg_not_scalar", ["bytes.lit", "data_model.yaml:not_scalar"]],
        ["let", "tag", ["ext.data_model.kind_at", "doc", "off"]],
        ["if", ["<", "tag", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_value"]]], 0],
        ["let", "val", ["bytes.alloc", 0]],
        [
          "if",
          ["=", "tag", 0],
          ["set", "val", ["ext.data_model.value_null"]],
          [
            "if",
            ["=", "tag", 1],
            [
              "begin",
              ["let", "bv", ["ext.data_model.bool_get", "doc", "off"]],
              ["if", ["<", "bv", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_bool"]]], 0],
              ["set", "val", ["ext.data_model.value_bool", "bv"]],
              0
            ],
            [
              "if",
              ["=", "tag", 2],
              [
                "begin",
                ["let", "num", ["ext.data_model.number_get", "doc", "off"]],
                ["if", ["=", ["bytes.len", "num"], 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_number"]]], 0],
                ["set", "val", ["ext.data_model.value_number", ["bytes.view", "num"]]],
                0
              ],
              [
                "if",
                ["=", "tag", 3],
                [
                  "begin",
                  ["let", "s", ["ext.data_model.string_get", "doc", "off"]],
                  ["set", "val", ["ext.data_model.value_string", ["bytes.view", "s"]]],
                  0
                ],
                ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_not_scalar"]]]
              ]
            ]
          ]
        ],
        ["let", "tmp_doc", ["ext.data_model.doc_ok", ["bytes.view", "val"]]],
        ["let", "tmp_docv", ["bytes.view", "tmp_doc"]],
        ["let", "json_doc", ["ext.data_model.json.emit_canon", "tmp_docv"]],
        ["let", "json_docv", ["bytes.view", "json_doc"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "json_docv"], 1], ["return", ["ext.data_model.yaml._bytes_to_vec_u8", "json_docv"]], 0],
        ["let", "n", ["view.len", "json_docv"]],
        ["if", ["<", "n", 1], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_value"]]], 0],
        ["let", "payload", ["view.slice", "json_docv", 1, ["-", "n", 1]]],
        ["ext.data_model.yaml._extend_view", "out", "payload"]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml._emit_value_into",
      "params": [
        {"name": "out", "ty": "vec_u8"},
        {"name": "doc", "ty": "bytes_view"},
        {"name": "off", "ty": "i32"},
        {"name": "indent", "ty": "i32"}
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["let", "msg_invalid_value", ["bytes.lit", "data_model.yaml:invalid_value"]],
        ["let", "msg_invalid_map", ["bytes.lit", "data_model.yaml:invalid_map"]],
        ["let", "msg_invalid_seq", ["bytes.lit", "data_model.yaml:invalid_seq"]],
        ["let", "msg_invalid_map_value", ["bytes.lit", "data_model.yaml:invalid_map_value"]],
        ["let", "msg_invalid_seq_elem", ["bytes.lit", "data_model.yaml:invalid_seq_elem"]],
        ["let", "tag", ["ext.data_model.kind_at", "doc", "off"]],
        ["if", ["<", "tag", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_value"]]], 0],
        [
          "if",
          ["<", "tag", 4],
          ["ext.data_model.yaml._append_scalar_json_payload", "out", "doc", "off"],
          [
            "if",
            ["=", "tag", 4],
            [
              "begin",
              ["let", "count", ["ext.data_model.seq_len", "doc", "off"]],
              ["if", ["<", "count", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_seq"]]], 0],
              ["if", ["=", "count", 0], ["begin", ["let", "empty", ["bytes.lit", "[]"]], ["return", ["ext.data_model.yaml._extend_view", "out", ["bytes.view", "empty"]]]], 0],
              ["let", "o", "out"],
              [
                "for",
                "i",
                0,
                "count",
                [
                  "begin",
                  ["set", "o", ["ext.data_model.yaml._indent", "o", "indent"]],
                  ["set", "o", ["vec_u8.push", "o", 45]],
                  ["let", "elem_off", ["ext.data_model.seq_get", "doc", "off", "i"]],
                  ["if", ["<", "elem_off", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_seq_elem"]]], 0],
                  ["let", "etag", ["ext.data_model.kind_at", "doc", "elem_off"]],
                  ["if", ["<", "etag", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_seq_elem"]]], 0],
                  [
                    "if",
                    ["<", "etag", 4],
                    [
                      "begin",
                      ["set", "o", ["vec_u8.push", "o", 32]],
                      ["set", "o", ["ext.data_model.yaml._append_scalar_json_payload", "o", "doc", "elem_off"]],
                      ["if", ["=", ["vec_u8.get", "o", 0], 0], ["return", "o"], 0],
                      ["set", "o", ["vec_u8.push", "o", 10]],
                      0
                    ],
                    [
                      "begin",
                      ["set", "o", ["vec_u8.push", "o", 10]],
                      ["set", "o", ["ext.data_model.yaml._emit_value_into", "o", "doc", "elem_off", ["+", "indent", 2]]],
                      ["if", ["=", ["vec_u8.get", "o", 0], 0], ["return", "o"], 0],
                      ["set", "o", ["ext.data_model.yaml._ensure_trailing_newline", "o"]],
                      0
                    ]
                  ],
                  0
                ]
              ],
              "o"
            ],
            [
              "if",
              ["=", "tag", 5],
              [
                "begin",
                ["let", "count", ["ext.data_model.map_len", "doc", "off"]],
                ["if", ["<", "count", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_map"]]], 0],
                ["if", ["=", "count", 0], ["begin", ["let", "empty", ["bytes.lit", "{}"]], ["return", ["ext.data_model.yaml._extend_view", "out", ["bytes.view", "empty"]]]], 0],
                ["let", "o", "out"],
                [
                  "for",
                  "i",
                  0,
                  "count",
                  [
                    "begin",
                    ["set", "o", ["ext.data_model.yaml._indent", "o", "indent"]],
                    ["let", "key", ["ext.data_model.map_key_at", "doc", "off", "i"]],
                    ["let", "key_val", ["ext.data_model.value_string", ["bytes.view", "key"]]],
                    ["let", "key_doc", ["ext.data_model.doc_ok", ["bytes.view", "key_val"]]],
                    ["let", "key_json_doc", ["ext.data_model.json.emit_canon", ["bytes.view", "key_doc"]]],
                    ["let", "key_json_v", ["bytes.view", "key_json_doc"]],
                    ["if", ["=", ["ext.data_model.doc_is_err", "key_json_v"], 1], ["return", ["ext.data_model.yaml._bytes_to_vec_u8", "key_json_v"]], 0],
                    ["let", "kn", ["view.len", "key_json_v"]],
                    ["if", ["<", "kn", 1], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_value"]]], 0],
                    ["let", "key_payload", ["view.slice", "key_json_v", 1, ["-", "kn", 1]]],
                    ["set", "o", ["ext.data_model.yaml._extend_view", "o", "key_payload"]],
                    ["set", "o", ["vec_u8.push", "o", 58]],
                    ["let", "val_off", ["ext.data_model.map_value_at", "doc", "off", "i"]],
                    ["if", ["<", "val_off", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_map_value"]]], 0],
                    ["let", "vtag", ["ext.data_model.kind_at", "doc", "val_off"]],
                    ["if", ["<", "vtag", 0], ["return", ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_map_value"]]], 0],
                    [
                      "if",
                      ["<", "vtag", 4],
                      [
                        "begin",
                        ["set", "o", ["vec_u8.push", "o", 32]],
                        ["set", "o", ["ext.data_model.yaml._append_scalar_json_payload", "o", "doc", "val_off"]],
                        ["if", ["=", ["vec_u8.get", "o", 0], 0], ["return", "o"], 0],
                        ["set", "o", ["vec_u8.push", "o", 10]],
                        0
                      ],
                      [
                        "begin",
                        ["set", "o", ["vec_u8.push", "o", 10]],
                        ["set", "o", ["ext.data_model.yaml._emit_value_into", "o", "doc", "val_off", ["+", "indent", 2]]],
                        ["if", ["=", ["vec_u8.get", "o", 0], 0], ["return", "o"], 0],
                        ["set", "o", ["ext.data_model.yaml._ensure_trailing_newline", "o"]],
                        0
                      ]
                    ],
                    0
                  ]
                ],
                "o"
              ],
              ["ext.data_model.yaml._err_from_msg", ["bytes.view", "msg_invalid_value"]]
            ]
          ]
        ]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.yaml.emit_canon",
      "params": [{"name": "doc", "ty": "bytes_view"}],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "msg_root_invalid", ["bytes.lit", "data_model.yaml:invalid_root"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "doc"], 1], ["return", ["view.to_bytes", "doc"]], 0],
        ["let", "root_kind", ["ext.data_model.root_kind", "doc"]],
        ["if", ["<", "root_kind", 0], ["return", ["ext.data_model.doc_err_from_msg", ["bytes.view", "msg_root_invalid"]]], 0],
        ["let", "root_off", ["ext.data_model.root_offset", "doc"]],
        ["if", ["<", "root_off", 0], ["return", ["ext.data_model.doc_err_from_msg", ["bytes.view", "msg_root_invalid"]]], 0],
        ["let", "out", ["vec_u8.with_capacity", ["+", 16, ["view.len", "doc"]]]],
        ["set", "out", ["ext.data_model.yaml._emit_value_into", "out", "doc", "root_off", 0]],
        ["if", ["=", ["vec_u8.get", "out", 0], 0], ["return", ["vec_u8.into_bytes", "out"]], 0],
        ["set", "out", ["ext.data_model.yaml._ensure_trailing_newline", "out"]],
        ["let", "yaml_bytes", ["vec_u8.into_bytes", "out"]],
        ["ext.data_model.doc_ok", ["bytes.view", "yaml_bytes"]]
      ]
    }
  ]
}
