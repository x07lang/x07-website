{"decls":[{"kind":"export","names":["std.net.http.server.read_req_task_v1","std.net.http.server.read_req_v1","std.net.http.server.req_body_v1","std.net.http.server.req_header_get_v1","std.net.http.server.req_method_v1","std.net.http.server.req_target_v1","std.net.http.server.write_response_task_v1","std.net.http.server.write_response_v1"]},{"body":["begin",["let","n",["view.len","table"]],["if",["<","n",4],["return","out"],0],["let","count",["codec.read_u32_le","table",0]],["if",["<","count",0],["return","out"],0],["let","pos",4],["let","cl",["bytes.lit","content-length"]],["let","conn",["bytes.lit","connection"]],["for","_",0,"count",["begin",["if",[">=u",["+","pos",4],["+","n",1]],["return","out"],0],["let","klen",["codec.read_u32_le","table","pos"]],["if",["<","klen",0],["return","out"],0],["set","pos",["+","pos",4]],["if",[">=u",["+","pos","klen"],["+","n",1]],["return","out"],0],["let","k",["view.slice","table","pos","klen"]],["set","pos",["+","pos","klen"]],["if",[">=u",["+","pos",4],["+","n",1]],["return","out"],0],["let","vlen",["codec.read_u32_le","table","pos"]],["if",["<","vlen",0],["return","out"],0],["set","pos",["+","pos",4]],["if",[">=u",["+","pos","vlen"],["+","n",1]],["return","out"],0],["let","v",["view.slice","table","pos","vlen"]],["set","pos",["+","pos","vlen"]],["if",["<=","klen",0],0,["if",["view.eq","k",["bytes.view","cl"]],0,["if",["view.eq","k",["bytes.view","conn"]],0,["if",["std.net.http.server._has_bad_header_bytes_v1","k"],0,["if",["std.net.http.server._has_bad_header_bytes_v1","v"],0,["begin",["set","out",["vec_u8.extend_bytes_range","out","k",0,"klen"]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes_range","out","v",0,"vlen"]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],0]]]]]],0]],"out"],"kind":"defn","name":"std.net.http.server._append_headers_table_v1","params":[{"name":"out","ty":"vec_u8"},{"name":"table","ty":"bytes_view"}],"result":"vec_u8"},{"body":["begin",["let","n",["view.len","b"]],["if",["<","n",4],["return",-1],0],["for","i",0,["-","n",3],["begin",["if",["=",["view.get_u8","b","i"],13],["if",["=",["view.get_u8","b",["+","i",1]],10],["if",["=",["view.get_u8","b",["+","i",2]],13],["if",["=",["view.get_u8","b",["+","i",3]],10],["return",["+","i",4]],0],0],0],0],0]],-1],"kind":"defn","name":"std.net.http.server._find_crlfcrlf_end_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","b"]],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["if",["=","c",0],["return",1],0],["if",["=","c",13],["return",1],0],["if",["=","c",10],["return",1],0],0]],0],"kind":"defn","name":"std.net.http.server._has_bad_header_bytes_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","b"]],["if",["=","n",0],["return",0],0],["let","x",0],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["if",["if",[">=u","c",48],["<u","c",58],0],0,["return",-1]],["let","d",["-","c",48]],["if",[">","x",214748364],["return",-1],0],["if",["if",["=","x",214748364],[">","d",7],0],["return",-1],0],["set","x",["+",["*","x",10],"d"]],0]],"x"],"kind":"defn","name":"std.net.http.server._parse_u32_dec_or_0_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","pdv",["bytes.view","parse_doc"]],["let","pd_len",["view.len","pdv"]],["if",["<","pd_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_internal_v1"]]],0],["let","msg_len",["view.len","msg"]],["if",["<","msg_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_internal_v1"]]],0],["let","out",["vec_u8.with_capacity",["+",12,["+","pd_len","msg_len"]]]],["set","out",["vec_u8.push","out",1]],["set","out",["vec_u8.push","out",1]],["set","out",["vec_u8.push","out",0]],["set","out",["vec_u8.push","out",0]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","pd_len"]]],["set","out",["vec_u8.extend_bytes_range","out","pdv",0,"pd_len"]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","msg_len"]]],["set","out",["vec_u8.extend_bytes_range","out","msg",0,"msg_len"]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.net.http.server._req_doc_ok_v1","params":[{"name":"parse_doc","ty":"bytes"},{"name":"msg","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","doc"]],["if",["<","n",12],["return",["bytes.alloc",0]],0],["if",["!=",["view.get_u8","doc",0],1],["return",["bytes.alloc",0]],0],["if",["!=",["view.get_u8","doc",1],1],["return",["bytes.alloc",0]],0],["let","pd_len",["codec.read_u32_le","doc",4]],["if",["<","pd_len",0],["return",["bytes.alloc",0]],0],["let","msg_len_off",["+",8,"pd_len"]],["if",[">=u",["+","msg_len_off",4],["+","n",1]],["return",["bytes.alloc",0]],0],["let","msg_len",["codec.read_u32_le","doc","msg_len_off"]],["if",["<","msg_len",0],["return",["bytes.alloc",0]],0],["let","msg_off",["+","msg_len_off",4]],["if",["!=",["+","msg_off","msg_len"],"n"],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","doc","msg_off","msg_len"]]],"kind":"defn","name":"std.net.http.server._req_msg_v1","params":[{"name":"doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","doc"]],["if",["<","n",12],["return",["bytes.alloc",0]],0],["if",["!=",["view.get_u8","doc",0],1],["return",["bytes.alloc",0]],0],["if",["!=",["view.get_u8","doc",1],1],["return",["bytes.alloc",0]],0],["let","pd_len",["codec.read_u32_le","doc",4]],["if",["<","pd_len",0],["return",["bytes.alloc",0]],0],["let","pd_off",8],["if",[">=u",["+","pd_off","pd_len"],["+","n",1]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","doc","pd_off","pd_len"]]],"kind":"defn","name":"std.net.http.server._req_parse_doc_v1","params":[{"name":"doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","max_total",["std.net.codec.caps_max_read_bytes_v1","caps"]],["let","max_total2",["if",["<=","max_total",0],1048576,"max_total"]],["let","buf",["vec_u8.with_capacity",0]],["let","total",0],["let","header_end",-1],["let","need",-1],["for","_",0,2147483647,["begin",["let","want",4096],["if",["!=","need",-1],["begin",["let","rem",["-","need","total"]],["if",["<","rem","want"],["set","want","rem"],0],0],["begin",["let","rem",["-","max_total2","total"]],["if",["<","rem","want"],["set","want","rem"],0],0]],["if",["<=","want",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_too_large_v1"]]],0],["let","rdoc",["std.net.tcp.stream_read_v1","stream_handle","want","caps"]],["let","is_err",["begin",["let","dv",["bytes.view","rdoc"]],["std.net.err.is_err_doc_v1","dv"]]],["if","is_err",["return","rdoc"],0],["let","chunk",["std.net.tcp.stream_read_payload_v1",["bytes.view","rdoc"]]],["let","chunk_len",["bytes.len","chunk"]],["if",["<=","chunk_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_connect_v1"]]],0],["set","buf",["vec_u8.extend_bytes","buf","chunk"]],["set","total",["+","total","chunk_len"]],["if",["=","header_end",-1],["begin",["let","bview",["vec_u8.as_view","buf"]],["set","header_end",["std.net.http.server._find_crlfcrlf_end_v1","bview"]],["if",["!=","header_end",-1],["begin",["let","parse0",["ext.httparse.parse_request","bview"]],["let","parse0_v",["bytes.view","parse0"]],["if",["ext.httparse.is_err","parse0_v"],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["let","k",["bytes.lit","content-length"]],["let","cl_b",["ext.httparse.header_get","parse0_v","bview",["bytes.view","k"]]],["let","cl",["std.net.http.server._parse_u32_dec_or_0_v1",["bytes.view","cl_b"]]],["if",["<","cl",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["set","need",["+","header_end","cl"]],["if",[">","need","max_total2"],["return",["std.net.err.make_doc_v1",["std.net.err.code_too_large_v1"]]],0],0],0],0],0],["if",["if",["!=","need",-1],[">=","total","need"],0],["begin",["let","bview",["vec_u8.as_view","buf"]],["let","req_view",["view.slice","bview",0,"need"]],["let","parse",["ext.httparse.parse_request","req_view"]],["let","parse_is_err",["begin",["let","dv",["bytes.view","parse"]],["ext.httparse.is_err","dv"]]],["if","parse_is_err",["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["return",["std.net.http.server._req_doc_ok_v1","parse","req_view"]]],0],0]],["std.net.err.make_doc_v1",["std.net.err.code_internal_v1"]]],"kind":"defn","name":"std.net.http.server.read_req_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pd",["std.net.http.server._req_parse_doc_v1","req"]],["let","msg",["std.net.http.server._req_msg_v1","req"]],["let","pdv",["bytes.view","pd"]],["let","msgv",["bytes.view","msg"]],["if",["ext.httparse.is_err","pdv"],["return",["bytes.alloc",0]],0],["ext.httparse.body","pdv","msgv"]],"kind":"defn","name":"std.net.http.server.req_body_v1","params":[{"name":"req","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pd",["std.net.http.server._req_parse_doc_v1","req"]],["let","msg",["std.net.http.server._req_msg_v1","req"]],["let","pdv",["bytes.view","pd"]],["let","msgv",["bytes.view","msg"]],["if",["ext.httparse.is_err","pdv"],["return",["bytes.alloc",0]],0],["ext.httparse.header_get","pdv","msgv","name"]],"kind":"defn","name":"std.net.http.server.req_header_get_v1","params":[{"name":"req","ty":"bytes_view"},{"name":"name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pd",["std.net.http.server._req_parse_doc_v1","req"]],["let","msg",["std.net.http.server._req_msg_v1","req"]],["let","pdv",["bytes.view","pd"]],["let","msgv",["bytes.view","msg"]],["if",["ext.httparse.is_err","pdv"],["return",["bytes.alloc",0]],0],["ext.httparse.method","pdv","msgv"]],"kind":"defn","name":"std.net.http.server.req_method_v1","params":[{"name":"req","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pd",["std.net.http.server._req_parse_doc_v1","req"]],["let","msg",["std.net.http.server._req_msg_v1","req"]],["let","pdv",["bytes.view","pd"]],["let","msgv",["bytes.view","msg"]],["if",["ext.httparse.is_err","pdv"],["return",["bytes.alloc",0]],0],["ext.httparse.target","pdv","msgv"]],"kind":"defn","name":"std.net.http.server.req_target_v1","params":[{"name":"req","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","body_len",["view.len","body"]],["if",["<","body_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["let","st",["if",["<","status",0],200,"status"]],["let","out",["vec_u8.with_capacity",["+","body_len",256]]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","HTTP/1.1"]]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","st"]]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","OK"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","content-length"]]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","body_len"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","connection"]]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","close"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["std.net.http.server._append_headers_table_v1","out","headers_table"]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes_range","out","body",0,"body_len"]],["let","resp",["vec_u8.into_bytes","out"]],["std.net.io.write_all_v1","stream_handle",["bytes.view","resp"],"caps"]],"kind":"defn","name":"std.net.http.server.write_response_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"status","ty":"i32"},{"name":"headers_table","ty":"bytes_view"},{"name":"body","ty":"bytes_view"},{"name":"caps","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","max_total",["std.net.codec.caps_max_read_bytes_v1","caps"]],["let","max_total2",["if",["<=","max_total",0],1048576,"max_total"]],["let","buf",["vec_u8.with_capacity",0]],["let","total",0],["let","header_end",-1],["let","need",-1],["for","_",0,2147483647,["begin",["let","want",4096],["if",["!=","need",-1],["begin",["let","rem",["-","need","total"]],["if",["<","rem","want"],["set","want","rem"],0],0],["begin",["let","rem",["-","max_total2","total"]],["if",["<","rem","want"],["set","want","rem"],0],0]],["if",["<=","want",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_too_large_v1"]]],0],["let","h",["std.net.tcp.stream_read_task_v1","stream_handle","want","caps","max_iters"]],["task.spawn","h"],["let","rdoc",["await","h"]],["let","dv",["bytes.view","rdoc"]],["let","is_err",["std.net.err.is_err_doc_v1","dv"]],["if","is_err",["begin",["let","code",["std.net.err.err_code_v1","dv"]],["return",["std.net.err.make_doc_v1","code"]],0],0],["let","chunk",["std.net.tcp.stream_read_payload_v1","dv"]],["let","chunk_v",["bytes.view","chunk"]],["let","chunk_len",["view.len","chunk_v"]],["if",["<=","chunk_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_connect_v1"]]],0],["set","buf",["vec_u8.extend_bytes","buf","chunk_v"]],["set","total",["+","total","chunk_len"]],["if",["=","header_end",-1],["begin",["let","bview",["vec_u8.as_view","buf"]],["set","header_end",["std.net.http.server._find_crlfcrlf_end_v1","bview"]],["if",["!=","header_end",-1],["begin",["let","parse0",["ext.httparse.parse_request","bview"]],["let","parse0_v",["bytes.view","parse0"]],["if",["ext.httparse.is_err","parse0_v"],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["let","k",["bytes.lit","content-length"]],["let","cl_b",["ext.httparse.header_get","parse0_v","bview",["bytes.view","k"]]],["let","cl",["std.net.http.server._parse_u32_dec_or_0_v1",["bytes.view","cl_b"]]],["if",["<","cl",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["set","need",["+","header_end","cl"]],["if",[">","need","max_total2"],["return",["std.net.err.make_doc_v1",["std.net.err.code_too_large_v1"]]],0],0],0],["let","buf2",["vec_u8.with_capacity","total"]],["set","buf2",["vec_u8.extend_bytes","buf2","bview"]],["set","buf","buf2"],0],0],["if",["if",["!=","need",-1],[">=","total","need"],0],["begin",["let","bview",["vec_u8.as_view","buf"]],["let","req_view",["view.slice","bview",0,"need"]],["let","parse",["ext.httparse.parse_request","req_view"]],["let","parse_is_err",["ext.httparse.is_err","parse"]],["if","parse_is_err",["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["return",["std.net.http.server._req_doc_ok_v1","parse","req_view"]]],0],0]],["std.net.err.make_doc_v1",["std.net.err.code_internal_v1"]]],"kind":"defasync","name":"std.net.http.server.read_req_task_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"},{"name":"max_iters","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","body_len",["view.len","body"]],["if",["<","body_len",0],["return",["std.net.err.make_doc_v1",["std.net.err.code_invalid_req_v1"]]],0],["let","st",["if",["<","status",0],200,"status"]],["let","out",["vec_u8.with_capacity",["+","body_len",256]]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","HTTP/1.1"]]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","st"]]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","OK"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","content-length"]]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","body_len"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","connection"]]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",32]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","close"]]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["std.net.http.server._append_headers_table_v1","out","headers_table"]],["set","out",["vec_u8.push","out",13]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.extend_bytes_range","out","body",0,"body_len"]],["let","resp",["vec_u8.into_bytes","out"]],["let","h",["std.net.io.write_all_task_v1","stream_handle",["bytes.view","resp"],"caps","max_iters"]],["task.spawn","h"],["await","h"]],"kind":"defasync","name":"std.net.http.server.write_response_task_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"status","ty":"i32"},{"name":"headers_table","ty":"bytes_view"},{"name":"body","ty":"bytes_view"},{"name":"caps","ty":"bytes_view"},{"name":"max_iters","ty":"i32"}],"result":"bytes"}],"imports":["ext.httparse","std.net.codec","std.net.err","std.net.io","std.net.tcp"],"kind":"module","module_id":"std.net.http.server","schema_version":"x07.x07ast@0.3.0"}
