{"decls":[{"kind":"export","names":["app.solve"]},{"body":["begin",["let","open",["bytes.lit","<h1>"]],["let","close",["bytes.lit","</h1>"]],["let","p0",["app.find_subseq_v1","html",0,["bytes.view","open"]]],["if",["<","p0",0],["return",["bytes.alloc",0]],0],["let","start",["+","p0",["view.len",["bytes.view","open"]]]],["let","p1",["app.find_subseq_v1","html","start",["bytes.view","close"]]],["if",["<","p1",0],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","html","start",["-","p1","start"]]]],"kind":"defn","name":"app.extract_h1_v1","params":[{"name":"html","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","hay_len",["view.len","hay"]],["let","needle_len",["view.len","needle"]],["if",["<","needle_len",1],["return",-1],0],["let","start0",["if",["<","start",0],0,"start"]],["if",[">=u","start0","hay_len"],["return",-1],0],["let","end",["-","hay_len","needle_len"]],["if",["<","end","start0"],["return",-1],0],["for","i","start0",["+","end",1],["if",["=",["std.bytes.cmp_range","hay","i","needle_len","needle",0,"needle_len"],0],["return","i"],0]],-1],"kind":"defn","name":"app.find_subseq_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["for","i","start","end",["if",["=",["view.get_u8","b","i"],"target"],["return","i"],0]],-1],"kind":"defn","name":"app.find_u8_from_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"end","ty":"i32"},{"name":"target","ty":"i32"}],"result":"i32"},{"body":["begin",["let","sl",["std.text.ascii.split_lines_view","lines"]],["let","slv",["bytes.view","sl"]],["let","count",["std.text.slices.count_v1","slv"]],["for","i",0,"count",["begin",["let","v",["std.text.slices.view_at_v1","lines","slv","i"]],["if",["=",["view.len","v"],0],0,["if",["=",["std.bytes.eq","v","needle"],1],["return",1],0]],0]],0],"kind":"defn","name":"app.lines_contains_v1","params":[{"name":"lines","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","s"]],["if",["<=","n",0],["return",-1],0],["let","v",0],["for","i",0,"n",["begin",["let","c",["view.get_u8","s","i"]],["if",["<u","c",48],["return",-1],0],["if",[">=u","c",58],["return",-1],0],["set","v",["+",["*","v",10],["-","c",48]]],0]],"v"],"kind":"defn","name":"app.parse_dec_u32_v1","params":[{"name":"s","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","argv_v1","b"],["let","opt_url",["bytes.lit","--url"]],["let","opt_depth",["bytes.lit","--depth"]],["let","opt_out",["bytes.lit","--out"]],["let","suffix_text",["bytes.lit",".text"]],["let","n",["view.len","argv_v1"]],["if",["<u","n",4],["return",["bytes.lit","ERROR:bad_argv_v1"]],0],["let","argc",["codec.read_u32_le","argv_v1",0]],["if",["<","argc",0],["return",["bytes.lit","ERROR:bad_argv_v1"]],0],["let","off",4],["let","want",0],["let","url",["bytes.alloc",0]],["let","depth_b",["bytes.alloc",0]],["let","out_path",["bytes.alloc",0]],["for","i",0,"argc",["begin",["if",["<u","n",["+","off",4]],["return",["bytes.lit","ERROR:bad_argv_v1"]],0],["let","len",["codec.read_u32_le","argv_v1","off"]],["let","start",["+","off",4]],["if",["<u","n",["+","start","len"]],["return",["bytes.lit","ERROR:bad_argv_v1"]],0],["let","tok",["view.slice","argv_v1","start","len"]],["set","off",["+","start","len"]],["if",["=","i",0],0,["begin",["if",["!=","want",0],["begin",["if",["=","want",1],["set","url",["view.to_bytes","tok"]],["if",["=","want",2],["set","depth_b",["view.to_bytes","tok"]],["set","out_path",["view.to_bytes","tok"]]]],["set","want",0],0],["begin",["let","t",["view.to_bytes","tok"]],["if",["=",["std.bytes.eq",["bytes.view","t"],["bytes.view","opt_url"]],1],["set","want",1],["if",["=",["std.bytes.eq",["bytes.view","t"],["bytes.view","opt_depth"]],1],["set","want",2],["if",["=",["std.bytes.eq",["bytes.view","t"],["bytes.view","opt_out"]],1],["set","want",3],0]]],0]],0]],0]],["if",["!=","want",0],["return",["bytes.lit","ERROR:missing_opt_value"]],0],["if",["if",["=",["view.len",["bytes.view","url"]],0],1,["=",["view.len",["bytes.view","out_path"]],0]],["return",["bytes.lit","ERROR:missing_args"]],0],["let","depth",["app.parse_dec_u32_v1",["bytes.view","depth_b"]]],["if",["<","depth",0],["return",["bytes.lit","ERROR:bad_depth"]],0],["let","origin",["app.url_origin_v1",["std.bytes.copy",["bytes.view","url"]]]],["if",["=",["view.len",["bytes.view","origin"]],0],["return",["bytes.lit","ERROR:bad_url"]],0],["let","caps_http",["std.net.http.spec.caps_default_v1"]],["let","caps_fs",["std.os.fs.spec.caps_default_v1"]],["let","all",["std.vec.with_capacity",1024]],["set","all",["std.vec.extend_bytes","all",["bytes.view","url"]]],["set","all",["std.vec.push","all",10]],["let","texts",["std.vec.with_capacity",128]],["let","frontier_v",["std.vec.with_capacity",1024]],["set","frontier_v",["std.vec.extend_bytes","frontier_v",["bytes.view","url"]]],["set","frontier_v",["std.vec.push","frontier_v",10]],["let","frontier",["std.vec.as_bytes","frontier_v"]],["let","stop",0],["for","d",0,["+","depth",1],["if",["=","stop",1],0,["begin",["if",["=",["view.len",["bytes.view","frontier"]],0],["set","stop",1],0],["if",["=","stop",1],0,["begin",["let","sl",["std.text.ascii.split_lines_view",["bytes.view","frontier"]]],["let","slv",["bytes.view","sl"]],["let","count",["std.text.slices.count_v1","slv"]],["let","next",["std.vec.with_capacity",1024]],["for","i",0,"count",["begin",["let","u",["std.text.slices.view_at_v1",["bytes.view","frontier"],"slv","i"]],["if",["=",["view.len","u"],0],0,["begin",["let","ub",["view.to_bytes","u"]],["let","resp",["std.net.http.client.get_v1","ub","caps_http"]],["if",["=",["std.net.http.client.resp_is_err_v1",["bytes.view","resp"]],1],["begin",["let","err",["std.net.http.client.resp_err_code_v1",["bytes.view","resp"]]],["let","prefix",["bytes.lit","ERROR:http_get_code="]],["let","url_k",["bytes.lit","_url="]],["let","code_b",["std.fmt.s32_to_dec","err"]],["let","tmp",["std.bytes.concat",["bytes.view","prefix"],["bytes.view","code_b"]]],["let","tmp2",["std.bytes.concat",["bytes.view","tmp"],["bytes.view","url_k"]]],["return",["std.bytes.concat",["bytes.view","tmp2"],"u"]],0],0],["let","body",["std.net.http.client.resp_body_v1",["bytes.view","resp"]]],["let","h1",["app.extract_h1_v1",["bytes.view","body"]]],["if",[">u",["view.len",["bytes.view","h1"]],0],["begin",["set","texts",["std.vec.extend_bytes","texts",["bytes.view","h1"]]],["set","texts",["std.vec.push","texts",10]],0],0],["let","links",["ext.html.links_abs_v1",["bytes.view","body"],["bytes.view","origin"]]],["let","ls",["std.text.ascii.split_lines_view",["bytes.view","links"]]],["let","lsv",["bytes.view","ls"]],["let","lc",["std.text.slices.count_v1","lsv"]],["for","k",0,"lc",["begin",["let","cand",["std.text.slices.view_at_v1",["bytes.view","links"],"lsv","k"]],["if",["=",["view.len","cand"],0],0,["begin",["if",["=",["app.lines_contains_v1",["vec_u8.as_view","all"],"cand"],1],0,["begin",["set","all",["std.vec.extend_bytes","all","cand"]],["set","all",["std.vec.push","all",10]],["set","next",["std.vec.extend_bytes","next","cand"]],["set","next",["std.vec.push","next",10]],0]],0]],0]],0]],0]],["set","frontier",["std.vec.as_bytes","next"]],0]],0]]],["let","all_b",["std.vec.as_bytes","all"]],["let","urls_sorted",["std.set.unique_lines_sorted",["bytes.view","all_b"]]],["let","urls_v",["std.vec.with_capacity",["+",["view.len",["bytes.view","urls_sorted"]],1]]],["set","urls_v",["std.vec.extend_bytes","urls_v",["bytes.view","urls_sorted"]]],["set","urls_v",["std.vec.push","urls_v",10]],["set","urls_sorted",["std.vec.as_bytes","urls_v"]],["let","w1",["std.os.fs.write_all_v1",["std.bytes.copy",["bytes.view","out_path"]],"urls_sorted",["std.bytes.copy",["bytes.view","caps_fs"]]]],["if",["!=",["result_i32.err_code","w1"],0],["return",["bytes.lit","ERROR:write_urls"]],0],["let","text_path",["std.bytes.concat",["bytes.view","out_path"],["bytes.view","suffix_text"]]],["let","t_b",["std.vec.as_bytes","texts"]],["let","w2",["std.os.fs.write_all_v1",["std.bytes.copy",["bytes.view","text_path"]],"t_b",["std.bytes.copy",["bytes.view","caps_fs"]]]],["if",["!=",["result_i32.err_code","w2"],0],["return",["bytes.lit","ERROR:write_text"]],0],["bytes.lit","ok"]],"kind":"defn","name":"app.solve","params":[{"name":"b","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","u",["bytes.view","url"]],["let","http",["bytes.lit","http://"]],["let","https",["bytes.lit","https://"]],["let","off",-1],["if",["=",["std.bytes.starts_with","u",["bytes.view","http"]],1],["set","off",7],["if",["=",["std.bytes.starts_with","u",["bytes.view","https"]],1],["set","off",8],0]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","n",["view.len","u"]],["let","slash",["app.find_u8_from_v1","u","off","n",47]],["if",["<","slash",0],["std.bytes.copy","u"],["std.bytes.slice","u",0,"slash"]]],"kind":"defn","name":"app.url_origin_v1","params":[{"name":"url","ty":"bytes"}],"result":"bytes"}],"imports":["ext.html","std.bytes","std.fmt","std.net.http.client","std.net.http.spec","std.os.fs","std.os.fs.spec","std.set","std.text.ascii","std.text.slices","std.vec"],"kind":"module","module_id":"app","schema_version":"x07.x07ast@0.3.0"}
