{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "ext.error.fmt",
  "imports": ["ext.error.context"],
  "decls": [
    {
      "kind": "export",
      "names": [
        "ext.error.fmt.format_error",
        "ext.error.fmt.format_error_chain"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.error.fmt._write_u32_decimal",
      "params": [{"name": "v", "ty": "vec_u8"}, {"name": "n", "ty": "i32"}],
      "result": "vec_u8",
      "body": ["begin",
        ["if", ["=", "n", 0],
          ["return", ["vec_u8.push", "v", 48]],
          0
        ],
        ["let", "buf", ["bytes.alloc", 10]],
        ["let", "idx", 0],
        ["let", "num", "n"],
        ["for", "_", 0, 10, ["begin",
          ["if", ["=", "num", 0], ["return", "v"], 0],
          ["let", "digit", ["%", "num", 10]],
          ["set", "buf", ["bytes.set_u8", "buf", "idx", ["+", 48, "digit"]]],
          ["set", "idx", ["+", "idx", 1]],
          ["set", "num", ["/", "num", 10]],
          0
        ]],
        ["for", "j", 0, "idx", ["begin",
          ["set", "v", ["vec_u8.push", "v", ["bytes.get_u8", "buf", ["-", ["-", "idx", "j"], 1]]]],
          0
        ]],
        "v"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.error.fmt.format_error",
      "params": [{"name": "err", "ty": "bytes_view"}],
      "result": "bytes",
      "body": ["begin",
        ["let", "code", ["ext.error.context.error_code", "err"]],
        ["let", "msg", ["ext.error.context.error_msg", "err"]],
        ["let", "msg_len", ["bytes.len", "msg"]],
        ["let", "v", ["vec_u8.with_capacity", ["+", 32, "msg_len"]]],
        ["set", "v", ["vec_u8.extend_bytes", "v", ["bytes.lit", "error"]]],
        ["if", [">", "code", 0], ["begin",
          ["set", "v", ["vec_u8.push", "v", 91]],
          ["set", "v", ["ext.error.fmt._write_u32_decimal", "v", "code"]],
          ["set", "v", ["vec_u8.push", "v", 93]],
          0
        ], 0],
        ["if", [">", "msg_len", 0], ["begin",
          ["set", "v", ["vec_u8.extend_bytes", "v", ["bytes.lit", ":"]]],
          ["set", "v", ["vec_u8.push", "v", 32]],
          ["set", "v", ["vec_u8.extend_bytes", "v", "msg"]],
          0
        ], 0],
        ["vec_u8.into_bytes", "v"]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.error.fmt.format_error_chain",
      "params": [{"name": "err", "ty": "bytes_view"}],
      "result": "bytes",
      "body": ["begin",
        ["let", "base", ["ext.error.fmt.format_error", "err"]],
        ["let", "count", ["ext.error.context.context_count", "err"]],
        ["if", ["=", "count", 0], ["return", "base"], 0],
        ["let", "v", ["vec_u8.with_capacity", ["+", ["bytes.len", "base"], ["*", "count", 32]]]],
        ["set", "v", ["vec_u8.extend_bytes", "v", "base"]],
        ["for", "i", 0, "count", ["begin",
          ["set", "v", ["vec_u8.push", "v", 10]],
          ["set", "v", ["vec_u8.push", "v", 32]],
          ["set", "v", ["vec_u8.push", "v", 32]],
          ["set", "v", ["vec_u8.extend_bytes", "v", ["bytes.lit", "caused"]]],
          ["set", "v", ["vec_u8.push", "v", 32]],
          ["set", "v", ["vec_u8.extend_bytes", "v", ["bytes.lit", "by:"]]],
          ["set", "v", ["vec_u8.push", "v", 32]],
          ["let", "ctx", ["ext.error.context.get_context", "err", "i"]],
          ["set", "v", ["vec_u8.extend_bytes", "v", "ctx"]],
          0
        ]],
        ["vec_u8.into_bytes", "v"]
      ]
    }
  ]
}
