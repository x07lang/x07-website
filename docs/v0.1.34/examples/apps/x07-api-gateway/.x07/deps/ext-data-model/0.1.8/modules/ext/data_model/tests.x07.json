{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "ext.data_model.tests",
  "imports": ["std.test", "ext.data_model"],
  "decls": [
    {
      "kind": "export",
      "names": [
        "ext.data_model.tests.test_map_sort_and_find",
        "ext.data_model.tests.test_seq_roundtrip",
        "ext.data_model.tests.test_string_roundtrip"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.tests._u32_le",
      "params": [{"name": "x", "ty": "i32"}],
      "result": "bytes",
      "body": ["codec.write_u32_le", "x"]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.tests._extend_view",
      "params": [
        {"name": "v", "ty": "vec_u8"},
        {"name": "b", "ty": "bytes_view"}
      ],
      "result": "vec_u8",
      "body": ["begin",
        ["let", "out", "v"],
        ["let", "n", ["view.len", "b"]],
        ["for", "i", 0, "n", ["begin",
          ["set", "out", ["vec_u8.push", "out", ["view.get_u8", "b", "i"]]],
          0
        ]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.tests.test_string_roundtrip",
      "params": [],
      "result": "result_i32",
      "body": ["begin",
        ["let", "s", ["bytes.lit", "hello"]],
        ["let", "val", ["ext.data_model.value_string", ["bytes.view", "s"]]],
        ["let", "doc", ["ext.data_model.doc_ok", ["bytes.view", "val"]]],
        ["let", "docv", ["bytes.view", "doc"]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.doc_is_err", "docv"], 0, ["std.test.code_assert_i32_eq"]]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.root_kind", "docv"], 3, ["std.test.code_assert_i32_eq"]]],
        ["let", "got", ["ext.data_model.string_get", "docv", 1]],
        ["try", ["std.test.assert_bytes_eq", "got", "s", ["std.test.code_assert_bytes_eq"]]],
        ["std.test.pass"]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.tests.test_map_sort_and_find",
      "params": [],
      "result": "result_i32",
      "body": ["begin",
        ["let", "ka_cmp", ["bytes.lit", "a"]],
        ["let", "kb_cmp", ["bytes.lit", "b"]],
        ["let", "ka_find", ["bytes.lit", "a"]],
        ["let", "kb_find", ["bytes.lit", "b"]],
        ["let", "ka_build", ["bytes.lit", "a"]],
        ["let", "kb_build", ["bytes.lit", "b"]],
        ["let", "n1", ["bytes.lit", "1"]],
        ["let", "sx", ["bytes.lit", "x"]],
        ["let", "va", ["ext.data_model.value_number", ["bytes.view", "n1"]]],
        ["let", "vb", ["ext.data_model.value_string", ["bytes.view", "sx"]]],
        ["try", ["std.test.assert_i32_eq", ["bytes.len", "va"], 6, 1901]],
        ["try", ["std.test.assert_i32_eq", ["bytes.len", "vb"], 6, 1902]],
        ["try", ["std.test.assert_i32_eq", ["view.get_u8", ["bytes.view", "va"], 0], 2, 1904]],
        ["try", ["std.test.assert_i32_eq", ["codec.read_u32_le", ["bytes.view", "va"], 1], 1, 1905]],
        ["try", ["std.test.assert_i32_eq", ["view.get_u8", ["bytes.view", "va"], 5], 49, 1906]],
        ["try", ["std.test.assert_i32_eq", ["view.get_u8", ["bytes.view", "vb"], 0], 3, 1907]],
        ["try", ["std.test.assert_i32_eq", ["codec.read_u32_le", ["bytes.view", "vb"], 1], 1, 1908]],
        ["try", ["std.test.assert_i32_eq", ["view.get_u8", ["bytes.view", "vb"], 5], 120, 1909]],
        ["let", "entries", ["vec_u8.with_capacity", 64]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["ext.data_model.tests._u32_le", 2]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["ext.data_model.tests._u32_le", 1]]],
        ["set", "entries", ["ext.data_model.tests._extend_view", "entries", ["bytes.view", "kb_build"]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["ext.data_model.tests._u32_le", ["bytes.len", "vb"]]]],
        ["set", "entries", ["ext.data_model.tests._extend_view", "entries", ["bytes.view", "vb"]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["ext.data_model.tests._u32_le", 1]]],
        ["set", "entries", ["ext.data_model.tests._extend_view", "entries", ["bytes.view", "ka_build"]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["ext.data_model.tests._u32_le", ["bytes.len", "va"]]]],
        ["set", "entries", ["ext.data_model.tests._extend_view", "entries", ["bytes.view", "va"]]],
        ["let", "entries_b", ["vec_u8.into_bytes", "entries"]],
        ["let", "map_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
        ["try", ["std.test.assert_true", [">", ["bytes.len", "map_val"], 0], ["std.test.code_assert_true"]]],
        ["try", ["std.test.assert_i32_eq", ["bytes.len", "map_val"], 27, 1903]],
        ["let", "doc", ["ext.data_model.doc_ok", ["bytes.view", "map_val"]]],
        ["let", "docv", ["bytes.view", "doc"]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.root_kind", "docv"], 5, ["std.test.code_assert_i32_eq"]]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.map_len", "docv", 1], 2, ["std.test.code_assert_i32_eq"]]],
        ["let", "v0_off", ["ext.data_model.map_value_at", "docv", 1, 0]],
        ["try", ["std.test.assert_true", [">=", "v0_off", 0], 1990]],
        ["let", "v0_tag", ["ext.data_model.kind_at", "docv", "v0_off"]],
        ["let", "v0_len_field", ["codec.read_u32_le", "docv", ["+", "v0_off", 1]]],
        ["try", ["std.test.assert_i32_eq", "v0_tag", 2, 1991]],
        ["try", ["std.test.assert_i32_eq", "v0_len_field", 1, 1992]],
        ["let", "v0_slice", ["view.to_bytes", ["view.slice", "docv", "v0_off", 6]]],
        ["let", "v0_exp_vec", ["vec_u8.with_capacity", 6]],
        ["set", "v0_exp_vec", ["vec_u8.push", "v0_exp_vec", 2]],
        ["set", "v0_exp_vec", ["vec_u8.extend_bytes", "v0_exp_vec", ["codec.write_u32_le", 1]]],
        ["set", "v0_exp_vec", ["vec_u8.push", "v0_exp_vec", 49]],
        ["let", "v0_expected", ["vec_u8.into_bytes", "v0_exp_vec"]],
        ["try", ["std.test.assert_bytes_eq", "v0_slice", "v0_expected", 1993]],
        ["let", "after0_dbg", ["ext.data_model.skip_value", "docv", "v0_off"]],
        ["if", ["=", "after0_dbg", 17], 0, ["return", ["std.test.fail", ["+", 6100, "after0_dbg"]]]],
        ["let", "k0", ["ext.data_model.map_key_at", "docv", 1, 0]],
        ["let", "k1", ["ext.data_model.map_key_at", "docv", 1, 1]],
        ["try", ["std.test.assert_bytes_eq", "k0", "ka_cmp", 2001]],
        ["let", "k1_len", ["bytes.len", "k1"]],
        ["if", ["=", "k1_len", 1], 0, ["return", ["std.test.fail", ["+", 6000, "k1_len"]]]],
        ["let", "k1c", ["bytes.get_u8", "k1", 0]],
        ["try", ["std.test.assert_i32_eq", "k1c", 98, 2005]],
        ["let", "off_b", ["ext.data_model.map_find", "docv", 1, ["bytes.view", "kb_find"]]],
        ["try", ["std.test.assert_true", [">=", "off_b", 0], ["std.test.code_assert_true"]]],
        ["let", "got_b", ["ext.data_model.string_get", "docv", "off_b"]],
        ["try", ["std.test.assert_bytes_eq", "got_b", ["bytes.lit", "x"], 2003]],
        ["let", "off_a", ["ext.data_model.map_find", "docv", 1, ["bytes.view", "ka_find"]]],
        ["try", ["std.test.assert_true", [">=", "off_a", 0], ["std.test.code_assert_true"]]],
        ["let", "got_a", ["ext.data_model.number_get", "docv", "off_a"]],
        ["try", ["std.test.assert_bytes_eq", "got_a", ["bytes.lit", "1"], 2004]],
        ["std.test.pass"]
      ]
    },
    {
      "kind": "defn",
      "name": "ext.data_model.tests.test_seq_roundtrip",
      "params": [],
      "result": "result_i32",
      "body": ["begin",
        ["let", "sx", ["bytes.lit", "x"]],
        ["let", "v0", ["ext.data_model.value_string", ["bytes.view", "sx"]]],
        ["let", "v1", ["ext.data_model.value_bool", 1]],
        ["let", "elems", ["vec_u8.with_capacity", 64]],
        ["set", "elems", ["vec_u8.extend_bytes", "elems", ["ext.data_model.tests._u32_le", 2]]],
        ["set", "elems", ["vec_u8.extend_bytes", "elems", ["ext.data_model.tests._u32_le", ["bytes.len", "v0"]]]],
        ["set", "elems", ["ext.data_model.tests._extend_view", "elems", ["bytes.view", "v0"]]],
        ["set", "elems", ["vec_u8.extend_bytes", "elems", ["ext.data_model.tests._u32_le", ["bytes.len", "v1"]]]],
        ["set", "elems", ["ext.data_model.tests._extend_view", "elems", ["bytes.view", "v1"]]],
        ["let", "elems_b", ["vec_u8.into_bytes", "elems"]],
        ["let", "seq_val", ["ext.data_model.value_seq_from_elems", ["bytes.view", "elems_b"]]],
        ["try", ["std.test.assert_true", [">", ["bytes.len", "seq_val"], 0], ["std.test.code_assert_true"]]],
        ["let", "doc", ["ext.data_model.doc_ok", ["bytes.view", "seq_val"]]],
        ["let", "docv", ["bytes.view", "doc"]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.seq_len", "docv", 1], 2, ["std.test.code_assert_i32_eq"]]],
        ["let", "off0", ["ext.data_model.seq_get", "docv", 1, 0]],
        ["let", "off1", ["ext.data_model.seq_get", "docv", 1, 1]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.kind_at", "docv", "off0"], 3, ["std.test.code_assert_i32_eq"]]],
        ["try", ["std.test.assert_bytes_eq", ["ext.data_model.string_get", "docv", "off0"], ["bytes.lit", "x"], ["std.test.code_assert_bytes_eq"]]],
        ["try", ["std.test.assert_i32_eq", ["ext.data_model.bool_get", "docv", "off1"], 1, ["std.test.code_assert_i32_eq"]]],
        ["std.test.pass"]
      ]
    }
  ]
}
