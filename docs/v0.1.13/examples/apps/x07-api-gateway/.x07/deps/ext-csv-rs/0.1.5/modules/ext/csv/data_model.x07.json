{"decls":[{"kind":"export","names":["ext.csv.data_model.parse"]},{"body":["ext.data_model.doc_err_from_msg","msg"],"kind":"defn","name":"ext.csv.data_model._err","params":[{"name":"msg","ty":"bytes_view"}],"result":"bytes"},{"body":["ext.csv.data_model._extend_view_range","v","b",0,["view.len","b"]],"kind":"defn","name":"ext.csv.data_model._extend_view","params":[{"name":"v","ty":"vec_u8"},{"name":"b","ty":"bytes_view"}],"result":"vec_u8"},{"body":["begin",["let","out","v"],["let","end",["+","start","len"]],["for","i","start","end",["begin",["set","out",["vec_u8.push","out",["view.get_u8","b","i"]]],0]],"out"],"kind":"defn","name":"ext.csv.data_model._extend_view_range","params":[{"name":"v","ty":"vec_u8"},{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"len","ty":"i32"}],"result":"vec_u8"},{"body":["begin",["let","msg_unclosed_quote",["bytes.lit","csv:unclosed_quote"]],["let","msg_bad_after_quote",["bytes.lit","csv:bad_after_quote"]],["let","msg_malformed",["bytes.lit","csv:malformed_doc"]],["let","msg_decode_failed",["bytes.lit","csv:decode_failed"]],["let","msg_seq_failed",["bytes.lit","csv:seq_build_failed"]],["let","raw",["ext.csv.csv_parse","src"]],["let","rawv",["bytes.view","raw"]],["if",["=",["ext.csv.csv_is_err","rawv"],1],["begin",["let","code",["ext.data_model.doc_error_code","rawv"]],["if",["=","code",1],["return",["ext.csv.data_model._err",["bytes.view","msg_unclosed_quote"]]],0],["if",["=","code",2],["return",["ext.csv.data_model._err",["bytes.view","msg_bad_after_quote"]]],0],["return",["ext.data_model.doc_err_from_code","code"]]],0],["let","n",["view.len","rawv"]],["if",["<","n",5],["return",["ext.csv.data_model._err",["bytes.view","msg_malformed"]]],0],["let","row_count",["codec.read_u32_le","rawv",1]],["let","payload",["vec_u8.with_capacity",64]],["let","pos",5],["let","ok",1],["for","row_i",0,"row_count",["begin",["if",["=","ok",0],0,["begin",["if",[">=u",["+","pos",4],["+","n",1]],["set","ok",0],0],["if",["=","ok",0],0,["begin",["let","col_count",["codec.read_u32_le","rawv","pos"]],["set","pos",["+","pos",4]],["let","row_payload",["vec_u8.with_capacity",32]],["for","col_i",0,"col_count",["begin",["if",["=","ok",0],0,["begin",["if",[">=u",["+","pos",4],["+","n",1]],["set","ok",0],0],["if",["=","ok",0],0,["begin",["let","len",["codec.read_u32_le","rawv","pos"]],["set","pos",["+","pos",4]],["if",[">=u",["+","pos","len"],["+","n",1]],["set","ok",0],0],["if",["=","ok",0],0,["begin",["let","s",["view.slice","rawv","pos","len"]],["let","val",["ext.data_model.value_string","s"]],["set","row_payload",["vec_u8.extend_bytes","row_payload",["codec.write_u32_le",["bytes.len","val"]]]],["set","row_payload",["vec_u8.extend_bytes","row_payload","val"]],["set","pos",["+","pos","len"]],0]]]]]],0]],["if",["=","ok",0],0,["begin",["let","row_payload_b",["vec_u8.into_bytes","row_payload"]],["let","row_elems",["vec_u8.with_capacity",["+",4,["bytes.len","row_payload_b"]]]],["set","row_elems",["vec_u8.extend_bytes","row_elems",["codec.write_u32_le","col_count"]]],["set","row_elems",["vec_u8.extend_bytes","row_elems","row_payload_b"]],["let","row_elems_b",["vec_u8.into_bytes","row_elems"]],["let","row_val",["ext.data_model.value_seq_from_elems",["bytes.view","row_elems_b"]]],["if",["=",["bytes.len","row_val"],0],["set","ok",0],0],["if",["=","ok",0],0,["begin",["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["bytes.len","row_val"]]]],["set","payload",["vec_u8.extend_bytes","payload","row_val"]],0]],0]],0]]]],0]],["if",["=","ok",0],["return",["ext.csv.data_model._err",["bytes.view","msg_decode_failed"]]],0],["if",["=","pos","n"],0,["return",["ext.csv.data_model._err",["bytes.view","msg_decode_failed"]]]],["let","payload_b",["vec_u8.into_bytes","payload"]],["let","elems",["vec_u8.with_capacity",["+",4,["bytes.len","payload_b"]]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","row_count"]]],["set","elems",["vec_u8.extend_bytes","elems","payload_b"]],["let","elems_b",["vec_u8.into_bytes","elems"]],["let","table_val",["ext.data_model.value_seq_from_elems",["bytes.view","elems_b"]]],["if",["=",["bytes.len","table_val"],0],["return",["ext.csv.data_model._err",["bytes.view","msg_seq_failed"]]],0],["ext.data_model.doc_ok",["bytes.view","table_val"]]],"kind":"defn","name":"ext.csv.data_model.parse","params":[{"name":"src","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.csv","ext.data_model"],"kind":"module","module_id":"ext.csv.data_model","schema_version":"x07.x07ast@0.3.0"}