{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "smoke",
  "imports": [
    "app",
    "std.json",
    "std.net.grpc",
    "std.net.ws",
    "std.test",
    "std.vec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "smoke.frames_roundtrip",
        "smoke.test_report_ok_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "smoke.assert_json_field_eq_v1",
      "params": [
        { "name": "json", "ty": "bytes_view" },
        { "name": "field", "ty": "bytes" },
        { "name": "want", "ty": "bytes" }
      ],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "qv", ["std.vec.with_capacity", ["+", ["view.len", "json"], ["+", ["bytes.len", "field"], 8]]]],
        ["set", "qv", ["std.vec.extend_bytes", "qv", "json"]],
        ["set", "qv", ["std.vec.push", "qv", 0]],
        ["set", "qv", ["std.vec.extend_bytes", "qv", ["bytes.view", "field"]]],
        ["let", "query", ["std.vec.as_bytes", "qv"]],
        ["let", "got", ["std.json.extract_path_canon_or_err", ["bytes.view", "query"]]],
        ["std.test.assert_bytes_eq", "got", "want", ["std.test.code_assert_bytes_eq"]]
      ]
    },
    {
      "kind": "defn",
      "name": "smoke.frames_roundtrip",
      "params": [],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "ws_payload0", ["bytes.lit", "hello"]],
        ["let", "ws_res", ["std.net.ws.frame_v1", 1, 1, ["bytes.view", "ws_payload0"]]],
        ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "ws_res"], 0, ["std.test.code_assert_i32_eq"]]],
        ["let", "ws_frame", ["result_bytes.unwrap_or", "ws_res", ["bytes.alloc", 0]]],
        ["try", ["std.test.assert_i32_eq", ["std.net.ws.frame_is_valid_v1", ["bytes.view", "ws_frame"]], 1, ["std.test.code_assert_i32_eq"]]],
        ["let", "ws_payload1", ["std.net.ws.frame_payload_v1", ["bytes.view", "ws_frame"]]],
        ["try", ["std.test.assert_bytes_eq", "ws_payload1", "ws_payload0", ["std.test.code_assert_bytes_eq"]]],
        ["let", "grpc_payload0", ["bytes.lit", "ping"]],
        ["let", "grpc_res", ["std.net.grpc.msg_prefix_v1", 0, ["bytes.view", "grpc_payload0"]]],
        ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "grpc_res"], 0, ["std.test.code_assert_i32_eq"]]],
        ["let", "grpc_frame", ["result_bytes.unwrap_or", "grpc_res", ["bytes.alloc", 0]]],
        ["let", "grpc_un", ["std.net.grpc.msg_unprefix_v1", ["bytes.view", "grpc_frame"]]],
        ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "grpc_un"], 0, ["std.test.code_assert_i32_eq"]]],
        ["let", "grpc_payload1", ["result_bytes.unwrap_or", "grpc_un", ["bytes.alloc", 0]]],
        ["try", ["std.test.assert_bytes_eq", "grpc_payload1", "grpc_payload0", ["std.test.code_assert_bytes_eq"]]],
        ["std.test.pass"]
      ]
    },
    {
      "kind": "defn",
      "name": "smoke.test_report_ok_v1",
      "params": [],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "empty", ["bytes.alloc", 0]],
        ["let", "out", ["app.main", ["bytes.view", "empty"]]],
        ["try", ["smoke.assert_json_field_eq_v1", ["bytes.view", "out"], ["bytes.lit", "ok"], ["bytes.lit", "1"]]],
        ["try", ["smoke.assert_json_field_eq_v1", ["bytes.view", "out"], ["bytes.lit", "ws_ok"], ["bytes.lit", "1"]]],
        ["try", ["smoke.assert_json_field_eq_v1", ["bytes.view", "out"], ["bytes.lit", "grpc_ok"], ["bytes.lit", "1"]]],
        ["std.test.pass"]
      ]
    }
  ]
}
